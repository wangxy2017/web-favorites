<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>网络收藏夹|首页</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="layui/css/layui.css">
    <style>
        /* 解决没有src属性时出现的边框 */
        img[src=""], img:not([src]){
            opacity:0;
        }
        /* 解决手机端宽度太小导致样式错乱 */
        body {
            min-width: 536px !important;
            height:1px;
        }

        /* 解决弹出框中select显示难看 */
        .to-fix-select .layui-layer-content {
            overflow: visible !important;
        }

        #userImg {
            font-size: 18px;
            font-weight: bold;
            margin-right: 5px;
            vertical-align: middle;
        }

        .search-div {
            z-index: 999;
            position: absolute;
            top: 16px;
            left: 200px;
            width: 200px;
            height: 30px;
        }

        .search-div input {
            height: 100%;
            font-size: 12px;
            border: none;
            background-color: #393d49;
            color: #b2b2b2;
        }

        .search-div i {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 20px;
            color: #666;
            display: none;
            cursor: pointer;
        }

        legend {
            cursor: pointer;
        }

        .add-icon {
            color: #666;
            font-size: 30px;
        }

        .favorites {
            display: flex;
            flex-wrap: wrap;
            overflow: hidden;
            padding: 10px;
        }

        .favorites li {
            display: flex;
            align-items: center;
            flex-direction: column;
            position: relative;
            padding: 10px 20px;
            cursor: pointer;
            user-select: none;
            border-radius: 4px;
        }

        .favorites li .favorites-bg {
            width: 80px;
            height: 80px;
            line-height: 80px;
            text-align: center;
            border-radius: 50%;
        }

        .favorites li .favorites-bg img {
            width: 50%;
            height: 50%;
            border: 0;
        }

        .favorites li.active {
            background-color: #f2f2f2;
        }

        .favorites li:hover {
            background-color: #f2f2f2;
        }

        .favorites li:hover .favorites-bg {
            background-color: #e5e7e8;
        }

        .favorites li p {
            width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 10px;
            text-align: center;
        }

        .favorites li .action-icon {
            position: absolute;
            top: 4px;
            right: 0;
            font-size: 20px;
            font-weight: bold;
            color: #666;
            display: none;
        }

        .favorites li:hover .action-icon {
            display: block;
        }

        /** 开源信息 **/
        .open-source {
            font-size: 12px;
            text-align: center;
        }

        .open-source a {
            margin-right: 10px;
            color: inherit;
        }

        .style-select{
            position: absolute;
            top: 12px;
            right: 140px;
        }

        .style-select .layui-form-switch{
            border:none;
            background-color: #393d49;
        }

        /** 书签模式 **/
        .bookmark .favorites li{
            flex-direction: row !important;
        }
        .bookmark .favorites li .favorites-bg{
            width: 16px !important;
            height: 16px !important;
            line-height: 16px !important;
            text-align: center !important;
            border-radius: 0 !important;
        }

        .bookmark .favorites li .favorites-bg img{
            width: 100% !important;
            height: 100% !important;
            border: 0 !important;
            vertical-align: baseline !important;
        }

        .bookmark .favorites li:hover .favorites-bg{
            background-color: transparent !important;
        }

        .bookmark .favorites li p{
            width: 300px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            margin-top: 0 !important;
            text-align: left !important;
            margin-left: 10px !important;
        }
        .bookmark .favorites li .action-icon{
            top: 8px !important;
        }
        .bookmark .favorites .add-icon{
            font-size: 16px !important;
        }
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo" style="cursor: pointer;" onclick="javascript:window.location.reload()">
            <img src="images/logo.svg" style="margin-right: 6px;width: 24px;vertical-align: text-top;">网络收藏夹
        </div>
        <div class="search-div">
            <input type="text" id="search_name" name="search_name" placeholder="搜索收藏地址" autocomplete="off"
                   class="layui-input">
            <i id="search_close" class="layui-icon layui-icon-close-fill"></i>
        </div>
        <div class="layui-form style-select" lay-filter="styleSelect">
            <div class="layui-input-inline">
                <input type="checkbox" name="style" id="styleSwitch" lay-skin="switch" lay-text="书签模式|常规模式" lay-filter="styleSwitch">
            </div>
        </div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <i class="layui-icon layui-icon-user" id="userImg"></i>
                    <span id="username">默认</span>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:;" id="changePwd">修改密码</a></dd>
                    <dd><a href="javascript:;" id="changeEmail">修改邮箱</a></dd>
                    <dd><a href="javascript:;" id="importOrExportBtn">导入/导出</a></dd>
                    <dd><a href="javascript:;" id="logout">安全退出</a></dd>
                </dl>
            </li>
        </ul>
    </div>

    <div class="layui-body" id="layuiBody" style="padding: 15px;left: 0;">
        <!-- 内容主体区域 -->
        <div class="layui-btn-container" style="position: fixed;left: 15px;bottom: 44px;z-index: 99999;">
            <button type="button" class="layui-btn layui-btn-sm" id="addCategoryBtn">添加分类</button>
            <button type="button" class="layui-btn layui-btn-sm" id="smartBtn">一键收藏</button>
        </div>
        <div id="starDiv">
            <fieldset class="layui-elem-field layui-field-title" style="border-radius: 0;margin: 0 2px;">
                <legend onclick="showStartFavorites()" style="font-size:16px;">常用网址</legend>
            </fieldset>
            <div id="starFavorites" style="display:none;"></div>
        </div>
        <div id="main" style="margin-top:10px;"></div>
    </div>
    <div class="layui-footer" style="left: 0;">
        <p class="open-source">
            本项目已开源，开源地址：<a href="https://gitee.com/wangxiaoyuan_2019/web-favorites.git" target="_blank">https://gitee.com/wangxiaoyuan_2019/web-favorites.git</a>
            QQ群：<a href="https://jq.qq.com/?_wv=1027&k=uMr09FnI" target="_blank">972265056</a>
        </p>
    </div>
</div>
<!-- 导入/导出 -->
<div class="layui-btn-container" id="importOrExport" style="display: none;margin: 16px 0;text-align: center">
    <button type="button" class="layui-btn" id="import">导入收藏</button>
    <button type="button" class="layui-btn" id="export">导出收藏</button>
</div>
<!-- 添加收藏表单 -->
<form class="layui-form" action="" id="add-favorites" lay-filter="add-favorites" style="display: none;padding: 10px">
    <input type="hidden" name="categoryId">
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-inline">
            <input type="text" name="url" id="url_input" required lay-verify="required|url" placeholder="请输入地址" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline">
            <input type="text" name="name" id="name_input" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
        <i id="url_loading" class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop" style="font-size: 22px;margin-top: 6px;display: none;"></i>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="addFavorites">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelAddFavorites">取消</button>
        </div>
    </div>
</form>
<!-- 编辑收藏表单 -->
<form class="layui-form" action="" id="update-favorites" lay-filter="update-favorites"
      style="display: none;padding: 10px">
    <input type="hidden" name="id" id="favoritesId">
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-inline">
            <input type="text" name="url" required lay-verify="required|url" placeholder="请输入地址" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline">
            <input type="text" name="name" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">选择分类</label>
        <div class="layui-input-inline">
            <select name="categoryId" id="categorySelect" lay-verify="required">
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">排序</label>
        <div class="layui-input-inline" style="width: 120px;">
            <input type="text" name="sort" lay-verify="sortNum" placeholder="请输入数值"
                   autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux">数值越大越靠前</div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">标记</label>
        <div class="layui-input-inline" style="width: 50px;">
            <input type="checkbox" name="star" lay-skin="switch" value="1" lay-filter="starSwitch">
        </div>
        <div class="layui-form-mid layui-word-aux">标记为常用网址</div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="updateFavorites">立即提交</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="deleteFavorites">删除</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-warm" id="settingPwd">管理密码</button>
        </div>
    </div>
</form>
<!-- 管理密码表单 -->
<form class="layui-form" action="" id="setting-pwd" lay-filter="setting-pwd"
      style="display: none;padding: 10px">
    <input type="hidden" name="id" id="pwdId">
    <input type="hidden" name="favoritesId">
    <div class="layui-form-item">
        <label class="layui-form-label" style="width:50px">账号</label>
        <div class="layui-input-inline">
            <input type="text" name="account" id="account" required lay-verify="required" placeholder="请输入账号" autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-inline">
            <button type="button" id="accountCopy" class="layui-btn layui-btn-primary layui-btn-xs" style="margin-top:8px" data-clipboard-target="#account">复制</button>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width:50px">密码</label>
        <div class="layui-input-inline">
            <input type="text" name="password" id="password" required lay-verify="required" placeholder="请输入密码" autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-inline">
            <button type="button" id="passwordCopy" class="layui-btn layui-btn-primary layui-btn-xs" style="margin-top:8px" data-clipboard-target="#password">复制</button>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="savePwd">保存</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="unsetPwd">清除密码</button>
        </div>
    </div>
</form>
<!-- 修改密码表单 -->
<form class="layui-form" action="" id="passwordForm" lay-filter="passwordForm" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">旧密码</label>
        <div class="layui-input-inline">
            <input type="password" name="oldPassword" required lay-verify="required" placeholder="请输入密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新密码</label>
        <div class="layui-input-inline">
            <input type="password" name="newPassword" required lay-verify="required" placeholder="请输入密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updatePassword">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelPwd">取消</button>
        </div>
    </div>
</form>
<!-- 修改邮箱表单 -->
<form class="layui-form" action="" id="emailForm" lay-filter="emailForm" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">新邮箱</label>
        <div class="layui-input-inline">
            <input type="text" name="newEmail" id="newEmail" required lay-verify="required|email|exitEmail" placeholder="请输入邮箱"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">验证码</label>
        <div class="layui-input-inline" style="width:106px;">
            <input type="text" name="code" required lay-verify="required" placeholder="请输入验证码"
                   autocomplete="off" class="layui-input">
        </div>
        <input type="button" class="layui-btn layui-btn-sm layui-btn-danger" style="margin-top:4px;" onclick="sendEmailCode(this)" value="获取验证码">
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updateEmail">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelEmail">取消</button>
        </div>
    </div>
</form>
<!-- 编辑分类表单 -->
<form class="layui-form" action="" id="update-category" lay-filter="update-category"
      style="display: none;padding: 10px">
    <input type="hidden" name="id">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline" style="width: 234px;">
            <input type="text" name="name" id="categoryName" required lay-verify="required" placeholder="请输入名称"
                   autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">排序</label>
        <div class="layui-input-inline" style="width: 120px;">
            <input type="text" name="sort" id="categorySort" lay-verify="sortNum" placeholder="请输入数值"
                   autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux">数值越大越靠前</div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="updateCategory">立即提交</button>
            <button type="button" class="layui-btn layui-btn-danger layui-btn-sm" id="deleteCategory">删除分类</button>
            <button type="button" class="layui-btn layui-btn-warm layui-btn-sm" id="clean">清空收藏</button>
        </div>
    </div>
</form>
<script src="layui/layui.js"></script>
<script src="layui/clipboard.min.js"></script>
<script>
    //JavaScript代码区域
    layui.use(['element', 'jquery', 'layer', 'form', 'upload','flow','util'], function () {
        var element = layui.element;
        var $ = layui.$;
        var layer = layui.layer;
        var form = layui.form;
        var upload = layui.upload;
        var flow = layui.flow;
        var util = layui.util;

        // 固定块
        util.fixbar({
            top: true
            , scrollElem: '#layuiBody'
            , bgcolor: '#393D49'
            , css: {right: 30, bottom: 50}
        });

        //执行实例
        var uploadInst = upload.render({
            elem: '#import' //绑定元素
            , accept: 'file'
            , acceptMime: 'file/xml'
            , exts: 'xml'
            , url: 'favorites/import' //上传接口
            , before: function(obj){
                layer.closeAll(); //关闭弹层
                layer.load(); //上传loading
            }
            , done: function (result) {
                layer.closeAll('loading'); //关闭loading
                if (result.code == 0) {
                    loadList();
                } else {
                    layer.msg('导入失败', {icon: 5});
                }
            }
            , error: function () {
                layer.closeAll('loading'); //关闭loading
                layer.msg('导入失败', {icon: 5});
            }
        });

        // 清除密码
        $("#unsetPwd").click(function(){
            var passwordId = $("#pwdId").val();
            if(passwordId == ""){
                layer.msg('未设置密码');
                return false;
            }
            layer.load();
            $.ajax({
                type: "DELETE",
                url: "password/" + passwordId,
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        layer.msg('操作成功', {icon: 6});
                        // 重置表单
                        form.val("setting-pwd", {
                            "id": ""
                            , "account": ""
                            , "password": ""
                        });
                    } else {
                       layer.msg('操作失败', {icon: 5});
                    }
                }
            });
        });

        $("#url_input").on('input',function(){
            var url = $(this).val();
            if(url.startsWith("https://") || url.startsWith("http://")){
                $("#name_input").addClass("layui-disabled").attr("disabled",true);
                $("#url_loading").show();
                // 请求后台解析url
                $.ajax({
                    type: "GET",
                    url: "favorites/url",
                    data: {"url": url},
                    dataType: "json",
                    success: function (result) {
                        $("#name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#url_loading").hide();

                        if (result.code == 0) {
                            $("#name_input").val(result.data);
                        }
                    },
                    error: function(){
                        $("#name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#url_loading").hide();
                    }
                });
            }
        });

        $("#settingPwd").click(function () {
            layer.open({
                type: 1,
                title: "管理登录此网站的密码",
                area: '360px',
                shade: 0,
                content: $('#setting-pwd')
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "password/fid/" + $("#favoritesId").val(),
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("setting-pwd", {
                            "id": data.id
                            , "favoritesId": data.favoritesId
                            , "account": data.account
                            , "password": data.password
                        });
                    } else {
                        form.val("setting-pwd", {
                            "id": ""
                            , "favoritesId": $("#favoritesId").val()
                            , "account": ""
                            , "password": ""
                        });
                    }
                }
            });
        });

        $("#export").click(function () {
            window.location.href = "favorites/export";
        });

        $("#cancelPwd").click(function () {
            layer.closeAll();
        });

        $("#cancelEmail").click(function () {
            layer.closeAll();
        });

        $("#cancelAddFavorites").click(function () {
            layer.closeAll();
        });

        $("#importOrExportBtn").click(function () {
            layer.open({
                type: 1,
                title: "导入收藏夹",
                area: '400px',
                content: $('#importOrExport')
            });
        });

        // 智能按钮
        $("#smartBtn").click(function () {
            layer.prompt({title: "一键收藏（默认分类）", placeholder: 'https://', maxlength: 500}, function (value, index, elem) {
                if(!value.startsWith("https://") && !value.startsWith("http://")){
                    layer.tips('链接格式不正确', elem, {tips: 1});
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: "favorites/smartAdd",
                    data: JSON.stringify({"url": value}),
                    contentType: 'application/json;charset=utf-8',
                    dataType: "json",
                    success: function (result) {
                        layer.closeAll('loading');
                        if (result.code == 0) {
                            loadList();
                        } else {
                            layer.msg('添加失败', {icon: 5});
                        }
                    }
                });
                layer.close(index);
                layer.load();
            });
        });

        // 关闭搜索
        $("#search_close").click(function () {
            loadList();
            $(this).hide();
            $("#search_name").val("").blur();
            $("#starDiv").show();
        });

        // 搜索
        $("#search_name").on("keydown", function (event) {
            // 1.按上下键进入选择模式，并控制，回车退出选择模式
            // 2.在选择模式时，按下回车跳转超链接，输入值，退出选择模式
            // 3.不在选择模式时，输入框有值，按下回车查询，输入框没有值，按下回车退出查询模式
            if (event.key === "Enter") {
                var activeLi = $(".favorites-li.active")[0];
                if(typeof activeLi !== "undefined"){
                    openUrl(activeLi);
                }else{
                    var name = $(this).val().trim();
                    if (name == "") { //退出搜索模式
                        loadList();
                        $("#starDiv").show();
                        $(this).blur();
                    } else { //进入搜索模式
                        layer.load();
                        $.ajax({
                            type: "GET",
                            url: "favorites/search",
                            data: {"name": name},
                            dataType: "json",
                            success: function (result) {
                                layer.closeAll('loading');
                                if (result.code == 0) {
                                    var html = '';
                                    html += '<ul class="favorites">';
                                    $.each(result.data, function (i, f) {
                                        html += '<li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" onclick="openUrl(this)">';
                                        html += '   <div class="favorites-bg">';
                                        html += '       <img src="' + f.icon + '" onerror="javascript:this.src=\'images/book.svg\'"/>';
                                        html += '   </div>';
                                        html += '   <p title="' + f.name + '">' + f.name + '</p>';
                                        html += '   <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                                        html += '</li>';
                                    });
                                    html += '</ul>';
                                    $("#main").empty().append(html);
                                    $("#starDiv").hide();
                                }
                            },
                            error: function(){
                                layer.closeAll('loading');
                                layer.msg('服务器异常', {icon: 2});
                            }
                        });
                    }
                }
            } else if (event.key === "ArrowDown") {
                var activeLi = $(".favorites-li.active")[0];
                if(typeof activeLi === "undefined"){
                    $(".favorites-li").eq(0).addClass("active");
                }else{
                    var nextActiveLi;
                    var last;
                    var list = $(".favorites-li");
                    list.each(function(index,item){
                        if($(item).hasClass("active")){
                            var nextIndex = index + 1;
                            nextActiveLi = list[nextIndex];
                            if(nextIndex + 1 === list.length){
                                last = true
                            }
                            return false;
                        }
                    });
                    if(typeof nextActiveLi !== "undefined"){
                        $(activeLi).removeClass("active");
                        $(nextActiveLi).addClass("active");
                        // 滚动
                        if(last){
                            $("#layuiBody").animate({scrollTop: $("#layuiBody")[0].scrollHeight}, 50);
                        }else{
                            elasticScroll(nextActiveLi.offsetTop);
                        }
                    }
                }
            } else if (event.key === "ArrowUp") {
                var activeLi = $(".favorites-li.active")[0];
                if(typeof activeLi === "undefined"){
                    $(".favorites-li").eq(0).addClass("active");
                }else{
                    var nextActiveLi;
                    var first;
                    var list = $(".favorites-li");
                    list.each(function(index,item){
                        if($(item).hasClass("active")){
                            var nextIndex = index - 1;
                            nextActiveLi = list[nextIndex];
                            if(nextIndex === 0){
                                first = true;
                            }
                            return false;
                        }
                    });
                    if(typeof nextActiveLi !== "undefined"){
                        $(activeLi).removeClass("active");
                        $(nextActiveLi).addClass("active");
                        // 滚动
                        if(first){
                            $("#layuiBody").animate({scrollTop: 0}, 50);
                        }else{
                            elasticScroll(nextActiveLi.offsetTop);
                        }
                    }
                }
            } else if (event.key === "Backspace") {
                $(".favorites-li.active").removeClass("active");
            }
        }).on("input", function () {
            if ($(this).val() != "") {
                $("#search_close").show();
            } else {
                $("#search_close").hide();
            }
            //退出选择模式
            $(".favorites-li.active").removeClass("active");
        });

        // 发送验证码
        window.sendEmailCode = function (obj) {
            var email = $("#newEmail").val();
            if(email != ""){
                // 倒计时
                var countdown = 60;
                var interval = setInterval(function() {
                    if (countdown == 0) {
                        obj.removeAttribute("disabled");
                        obj.value="获取验证码";
                        countdown = 60;
                        clearInterval(interval);
                    } else {
                        obj.setAttribute("disabled", true);
                        obj.value="重新发送(" + countdown + ")";
                        countdown--;
                    }
                }, 1000);
                // 请求后台
                $.ajax({
                    type: "GET",
                    url: "user/email/code",
                    data: {"email": email}
                });
            }else{
                $("#newEmail").focus().addClass("layui-form-danger");
                 layer.msg('必填项不能为空', {icon: 5, anim: 6});
            }
        };

        // 弹性滚动
        window.elasticScroll = function(height){
            var visibleHeight = $("#layuiBody").height();
            var shouldScroll = Math.floor(height/ visibleHeight) * visibleHeight;
            var scrollTop = $("#layuiBody").scrollTop();
            if(Math.abs(scrollTop - shouldScroll) >= visibleHeight){
                $("#layuiBody").animate({scrollTop: shouldScroll}, 50);
            }
        }

        // 打开新窗口
        window.openUrl = function (obj) {
            var url = $(obj).attr("data-url");
            if(url.startsWith("https://") || url.startsWith("http://")){
                window.open(url);
            }else{
                layer.msg('此链接无效', {icon: 7});
            }
        };

        // 编辑分类
        window.editCategory = function (obj) {
            layer.open({
                type: 1,
                title: "修改分类",
                area: '400px',
                content: $('#update-category')
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "category/" + $(obj).parent().attr("data-id"),
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-category", {
                            "id": data.id
                            , "name": data.name
                            , "sort": data.sort
                        });
                        //禁用系统分类
                        if (data.isSystem == 1) {
                            $("#categoryName").attr("disabled", true);
                            $("#categorySort").attr("disabled", true);
                        } else {
                            $("#categoryName").removeAttr("disabled");
                            $("#categorySort").removeAttr("disabled");
                        }
                    }
                }
            });
        };

        // 新增分类
        $("#addCategoryBtn").click(function () {
            layer.prompt({title: "添加分类", placeholder:"输入分类名称", maxlength: 10}, function (value, index, elem) {
                layer.close(index);
                layer.load();
                $.ajax({
                    type: "POST",
                    url: "category",
                    data: JSON.stringify({"name": value}),
                    contentType: 'application/json;charset=utf-8',
                    dataType: "json",
                    success: function (result) {
                        layer.closeAll('loading');
                        if (result.code == 0) {
                            loadList();
                            loadCategoryList();
                        }
                    }
                });
            });
        });

        // 修改密码
        $("#changePwd").click(function () {
            layer.open({
                type: 1,
                title: "修改密码",
                area: '400px',
                content: $('#passwordForm')
            });
            // 表单赋值
            form.val("passwordForm", {
                "oldPassword": ""
                , "newPassword": ""
            });
        });

        // 修改邮箱
        $("#changeEmail").click(function () {
            layer.open({
                type: 1,
                title: "修改邮箱",
                area: '400px',
                content: $('#emailForm')
            });
            // 表单赋值
            form.val("emailForm", {
                "newEmail": ""
                , "code": ""
            });
        });

        // 登出
        $("#logout").click(function () {
            $.ajax({
                type: "GET",
                url: "login/out",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        window.location.href = "login.html";
                    }
                }
            });
        });

        // 加载数据
        window.loadList = function () {
            $("#main").empty();
            flow.load({
                elem: '#main'
                , scrollElem: '#layuiBody'
                , isLazyimg: true
                , isAuto: true
                , mb: $("#layuiBody").height()
                , end: ' '
                , done: function(page, next){
                    var lis = [];
                    $.ajax({
                        type: "GET",
                        url: "favorites/list",
                        data: {"pageNum":page},
                        dataType: "json",
                        success: function (result) {
                            if (result.code == 0) {
                                // 加载数据
                                var html = '';
                                $.each(result.data.list, function (i, c) {
                                    html += '<fieldset class="layui-elem-field" data-id="' + c.id + '">';
                                    html += '   <legend onclick="editCategory(this)">' + c.name + '</legend>';
                                    html += '   <ul class="favorites">';
                                    $.each(c.favorites, function (j, f) {
                                        html += '<li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" onclick="openUrl(this)">';
                                        html += '           <div class="favorites-bg">';
                                        html += '               <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                                        html += '           </div>';
                                        html += '           <p title="' + f.name + '">' + f.name + '</p>';
                                        html += '           <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                                        html += '       </li>';
                                        if(j == 39){
                                            html += '       <li class="layui-anim layui-anim-fadein" onclick="moreFavorites(' + c.id + ')">';
                                            html += '           <div class="favorites-bg"><i class="add-icon layui-icon layui-icon-more"></i></div>';
                                            html += '           <p title="显示更多">显示更多</p>';
                                            html += '       </li>';
                                            return false;
                                        }
                                    });
                                    html += '       <li class="layui-anim layui-anim-fadein" onclick="addFavorites(' + c.id + ')">';
                                    html += '           <div class="favorites-bg"><i class="add-icon layui-icon layui-icon-add-1"></i></div>';
                                    html += '           <p title="添加收藏">添加收藏</p>';
                                    html += '       </li>';
                                    html += '   </ul>';
                                    html += '</fieldset>';
                                });
                                lis.push(html);
                                next(lis.join(''), page < result.data.pages);
                            }
                        },
                        error: function(){
                            layer.msg("服务器异常", {icon: 2});
                        }
                    });
                }
            });
        };

        // 加载分类
        window.loadCategoryList = function () {
            $.ajax({
                type: "GET",
                url: "category/list",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        var html = '';
                        $.each(result.data, function (i, c) {
                            html += '<option value="' + c.id + '">' + c.name + '</option>';
                        });
                        $("#categorySelect").empty().append(html);
                        form.render('select','update-favorites');
                    }
                }
            });
        };

        window.loadStarFavorites = function () {
            $.ajax({
                type: "GET",
                url: "favorites/star",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        if(result.data.length > 0){
                            var html = '';
                            html += '<ul class="favorites">';
                            $.each(result.data, function (i, f) {
                                html += '<li class="layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" onclick="openUrl(this)">';
                                html += '   <div class="favorites-bg">';
                                html += '       <img src="' + f.icon + '" onerror="javascript:this.src=\'images/book.svg\'"/>';
                                html += '   </div>';
                                html += '   <p title="' + f.name + '">' + f.name + '</p>';
                                html += '   <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                                html += '</li>';
                            });
                            html += '</ul>';
                            $("#starFavorites").empty().append(html);
                        }else{
                            $("#starFavorites").empty();
                        }
                    }
                }
            });
        };

        window.showStartFavorites = function () {
            var that = $("#starFavorites");
            if(that.is(":hidden")){
                that.show();
            }else{
                that.hide();
            }
        };

        // 显示更多
        window.moreFavorites = function (categoryId) {
            layer.load();
            $.ajax({
                type: "GET",
                url: "favorites/more",
                data: {"categoryId": categoryId},
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        var html = '';
                        $.each(result.data, function (i, f) {
                            html += '<li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" onclick="openUrl(this)">';
                            html += '           <div class="favorites-bg">';
                            html += '               <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                            html += '           </div>';
                            html += '           <p title="' + f.name + '">' + f.name + '</p>';
                            html += '           <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                            html += '       </li>';
                        });
                        html += '       <li class="layui-anim layui-anim-fadein" onclick="addFavorites(' + categoryId + ')">';
                        html += '           <div class="favorites-bg"><i class="add-icon layui-icon layui-icon-add-1"></i></div>';
                        html += '           <p title="添加收藏">添加收藏</p>';
                        html += '       </li>';
                        $("fieldset[data-id='" + categoryId + "']").find(".favorites").empty().append(html);
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                }
            });
        };

        // 添加收藏
        window.addFavorites = function (categoryId) {
            layer.open({
                type: 1,
                title: "添加收藏",
                area: '400px',
                content: $('#add-favorites')
            });
            // 表单赋值
            form.val("add-favorites", {
                "name": ""
                , "url": ""
                , "categoryId": categoryId
            });
        };

        // 删除收藏
        $("#deleteFavorites").click(function () {
            layer.confirm('确认删除收藏吗?', function(index){
                layer.close(index);
                layer.load();
                var data = form.val("update-favorites");
                $.ajax({
                    type: "GET",
                    url: "favorites/delete/" + data.id,
                    dataType: "json",
                    success: function (result) {
                        layer.closeAll();
                        if (result.code == 0) {
                            loadList();
                        } else {
                            layer.msg("删除失败", {icon: 5});
                        }
                    }
                });
            });
        });

        // 清空收藏
        $("#clean").click(function () {
            layer.confirm('确认清空分类下所有收藏吗?', function(index){
                layer.close(index);
                layer.load();
                var data = form.val("update-category");
                $.ajax({
                    type: "POST",
                    url: "category/clean",
                    data: {"id": data.id},
                    dataType: "json",
                    success: function (result) {
                        layer.closeAll();
                        if (result.code == 0) {
                            // 清空分类下的收藏
                            $("fieldset[data-id='" + data.id + "']").find(".favorites").children(":not(:last)").remove();
                        } else {
                            layer.msg(result.msg, {icon: 2});
                        }
                    }
                });
            });
        });

        // 删除分类
        $("#deleteCategory").click(function () {
            layer.confirm('确认删除分类吗?', function(index){
                layer.close(index);
                layer.load();
                var data = form.val("update-category");
                $.ajax({
                    type: "GET",
                    url: "category/delete/" + data.id,
                    dataType: "json",
                    success: function (result) {
                        layer.closeAll();
                        if (result.code == 0) {
                            // 删除分类
                            $("fieldset[data-id='" + data.id + "']").remove();
                            loadCategoryList();
                        } else {
                            layer.msg(result.msg, {icon: 2});
                        }
                    }
                });
            });
        });

        // 编辑收藏
        window.editFavorites = function (obj, e) {
            window.event ? window.event.cancelBubble = true : e.stopPropagation();//阻止冒泡
            layer.open({
                type: 1,
                title: "修改收藏",
                skin: 'to-fix-select',
                area: '400px',
                content: $('#update-favorites')
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "favorites/" + $(obj).parent().attr("data-id"),
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-favorites", {
                            "id": data.id
                            , "categoryId": data.categoryId
                            , "name": data.name
                            , "url": data.url
                            , "sort": data.sort
                            , "star": data.star
                        });
                    }
                }
            });
        };

        form.verify({
            sortNum: function (value, item) {
                if(value != ""){
                    if(isNaN(value)){
                        return "请输入 9999 以内的整数";
                    }else if(value%1 !== 0){
                        return "请输入 9999 以内的整数";
                    }else if(value > 9999){
                        return "请输入 9999 以内的整数";
                    }
                }
            },
            exitEmail: function (value, item) {
                var msg;
                $.ajax({
                    type: "GET",
                    url: 'register/email/' + value,
                    async: false, // 使用同步的方法
                    dataType: 'json',
                    success: function (result) {
                        if (result.code != 0) {
                            msg = "邮箱已存在";
                        }
                    }
                });
                return msg;
            }
        });

        form.on('switch(styleSwitch)', function(data){
            if(data.elem.checked){
                localStorage.setItem("bookmark", true);
                $("#layuiBody").addClass("bookmark");
            }else{
                localStorage.removeItem("bookmark");
                $("#layuiBody").removeClass("bookmark");
            }
        });

        form.on('switch(starSwitch)', function(data){
            layer.load();
            $.ajax({
                type: "POST",
                url: "favorites/star",
                data: JSON.stringify({"id": $("#favoritesId").val(),"star": data.elem.checked? 1 : 0}),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        layer.msg("操作成功", {icon: 6});
                        loadStarFavorites();
                    } else {
                        layer.msg(result.msg, {icon: 5});
                        // 回退
                        $(data.elem).removeAttr("checked");
                        $(data.othis).removeClass("layui-form-onswitch");
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                    // 回退
                    $(data.elem).removeAttr("checked");
                    $(data.othis).removeClass("layui-form-onswitch");
                }
            });
        });

        // 新增收藏
        form.on('submit(addFavorites)', function (data) {
            $.ajax({
                type: "POST",
                url: "favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        loadList();
                    } else {
                        layer.msg("添加失败", {icon: 5});
                    }
                }
            });
            layer.closeAll();
            layer.load();
            return false;
        });

        // 保存密码
        form.on('submit(savePwd)', function (data) {
            layer.load();
            $.ajax({
                type: "POST",
                url: "password",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("setting-pwd", {
                            "id": data.id
                            , "favoritesId": data.favoritesId
                            , "account": data.account
                            , "password": data.password
                        });
                        layer.msg("保存成功", {icon: 6});
                    } else {
                        layer.msg("保存失败", {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改邮箱
        form.on('submit(updateEmail)', function (data) {
            layer.closeAll();
            layer.load();
            $.ajax({
                type: "POST",
                url: "user/email",
                data: data.field,
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        layer.msg("修改成功", {icon: 6});
                    } else {
                        layer.msg("修改失败", {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改收藏
        form.on('submit(updateFavorites)', function (data) {
            layer.closeAll();
            layer.load();
            $.ajax({
                type: "POST",
                url: "favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        loadList();
                    } else {
                        layer.msg("修改失败", {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改分类
        form.on('submit(updateCategory)', function (data) {
            layer.closeAll();
            layer.load();
            $.ajax({
                type: "POST",
                url: "category",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        loadList();
                        loadCategoryList();
                    } else {
                        layer.msg("修改失败", {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改密码
        form.on('submit(updatePassword)', function (data) {
            layer.closeAll();
            layer.load();
            $.ajax({
                type: "POST",
                url: "user/password",
                data: data.field,
                dataType: "json",
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        layer.msg('修改成功', {icon: 6});
                        // 退出
                        setTimeout(function () {
                            $("#logout").trigger("click");
                        }, 1000);
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        window.initStyle = function(){
            var bookmark = localStorage.getItem("bookmark");
            if(bookmark){
                $("#styleSwitch").attr("checked",true);
                form.render('checkbox','styleSelect');
                $("#layuiBody").addClass("bookmark");
            }else{
                $("#styleSwitch").removeAttr("checked");
                form.render('checkbox','styleSelect');
                $("#layuiBody").removeClass("bookmark");
            }
        };

        window.loadUserInfo = function(){
            $.ajax({
                type: "GET",
                url: "user/info",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        var username = result.data.username;
                        $("#username").text(username.substring(0, 4));
                    }
                }
            });
        };

        window.initClipboard = function(){
            var clipboard = new ClipboardJS('#accountCopy');
            clipboard.on('success', function(e) {layer.msg("复制成功");});
            clipboard.on('error', function(e) {layer.msg("复制失败");});
            var clipboard1 = new ClipboardJS('#passwordCopy');
            clipboard1.on('success', function(e) {layer.msg("复制成功");});
            clipboard1.on('error', function(e) {layer.msg("复制失败");});
        };

        // 页面加载完成执行
        $(function () {
            // 书签模式
            initStyle();
            // 加载用户信息
            loadUserInfo();
            // 加载常用网址
            loadStarFavorites();
            // 加载数据
            loadList();
            // 加载分类
            loadCategoryList();
            // 初始化剪贴板插件
            initClipboard();
        });
    });
</script>
</body>
</html>