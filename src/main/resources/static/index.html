<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>网络收藏夹|首页</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/layui/css/layui.css">
    <style>
        /* 解决手机端宽度太小导致样式错乱 */
        body {
            min-width: 536px !important;
        }

        /* 解决弹出框中select显示难看 */
        .to-fix-select .layui-layer-content {
            overflow: visible;
        }

        #userImg {
            font-size: 18px;
            font-weight: bold;
            margin-right: 5px;
            vertical-align: middle;
        }

        .search-div {
            z-index: 999;
            position: absolute;
            top: 16px;
            left: 200px;
            width: 180px;
            height: 30px;
        }

        .search-div input {
            height: 100%;
            font-size: 12px;
            border: none;
            background-color: #393d49;
            color: #b2b2b2;
        }

        .search-div i {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 20px;
            color: #666;
            display: none;
            cursor: pointer;
        }

        legend {
            cursor: pointer;
        }

        .add-icon {
            color: #666;
            font-size: 30px;
        }

        .favorites {
            overflow: hidden;
            padding: 10px;
        }

        .favorites li {
            position: relative;
            float: left;
            padding: 10px 20px;
            cursor: pointer;
        }

        .favorites li .favorites-bg {
            width: 80px;
            height: 80px;
            line-height: 80px;
            text-align: center;
            border-radius: 50%;
        }

        .favorites li .favorites-bg img {
            width: 50%;
            height: 50%;
        }

        .favorites li:hover {
            background-color: #f2f2f2;
        }

        .favorites li:hover .favorites-bg {
            background-color: #e5e7e8;
        }

        .favorites li p {
            width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 10px;
            text-align: center;
            line-height: 22px;
        }

        .favorites li .action-icon {
            position: absolute;
            top: 4px;
            right: 0;
            font-size: 20px;
            font-weight: bold;
            color: #666;
            display: none;
        }

        .favorites li:hover .action-icon {
            display: block;
        }

        /** 开源信息 **/
        .open-source {
            font-size: 12px;
            text-align: center;
        }

        .open-source .star {
            margin-left: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo" style="cursor: pointer;" onclick="window.location.reload();">网络收藏夹</div>
        <div class="search-div">
            <input type="text" id="search_name" name="search_name" placeholder="搜索收藏地址" autocomplete="off"
                   class="layui-input">
            <i id="search_close" class="layui-icon layui-icon-close-fill"></i>
        </div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <i class="layui-icon layui-icon-user" id="userImg"></i>
                    <span id="username">默认用户</span>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:;" id="changePwd">修改密码</a></dd>
                    <dd><a href="javascript:;" id="importOrExportBtn">导入/导出</a></dd>
                    <dd><a href="javascript:;" id="logout">安全退出</a></dd>
                </dl>
            </li>
        </ul>
    </div>

    <div class="layui-body" style="padding: 15px;left: 0;">
        <!-- 内容主体区域 -->
        <div class="layui-btn-container" style="position: fixed;left: 15px;bottom: 44px;z-index: 99999;">
            <button type="button" class="layui-btn layui-btn-sm" id="addCategoryBtn">添加分类</button>
            <button type="button" class="layui-btn layui-btn-sm" id="smartBtn">智能收藏</button>
        </div>
        <div id="main"></div>
    </div>
    <div class="layui-footer" style="left: 0;">
        <p class="open-source">本项目已开源，开源地址：<a href="https://gitee.com/wangxiaoyuan_2019/web-favorites.git"
                                              target="_blank">https://gitee.com/wangxiaoyuan_2019/web-favorites.git<i
                class="layui-icon layui-icon-praise star"></i></a></p>
    </div>
</div>
<!-- 导入/导出 -->
<div class="layui-btn-container" id="importOrExport" style="display: none;margin: 16px 0;text-align: center">
    <button type="button" class="layui-btn" id="import">导入收藏</button>
    <button type="button" class="layui-btn" id="export">导出收藏</button>
</div>
<!-- 添加收藏表单 -->
<form class="layui-form" action="" id="add-favorites" lay-filter="add-favorites" style="display: none;padding: 10px">
    <input type="hidden" name="categoryId">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline">
            <input type="text" name="name" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-inline">
            <input type="text" name="url" required lay-verify="required" placeholder="请输入地址" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="addFavorites">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelAddFavorites">取消</button>
        </div>
    </div>
</form>
<!-- 编辑收藏表单 -->
<form class="layui-form" action="" id="update-favorites" lay-filter="update-favorites"
      style="display: none;padding: 10px">
    <input type="hidden" name="id">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline">
            <input type="text" name="name" required lay-verify="required" placeholder="请输入标题" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-inline">
            <input type="text" name="url" required lay-verify="required" placeholder="请输入标题" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">选择分类</label>
        <div class="layui-input-inline">
            <select name="categoryId" id="categoryId" lay-verify="required">
                <option value=""></option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updateFavorites">立即提交</button>
            <button type="button" class="layui-btn layui-btn-danger" id="deleteFavorites">删除</button>
        </div>
    </div>
</form>
<!-- 修改密码表单 -->
<form class="layui-form" action="" id="password" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">旧密码</label>
        <div class="layui-input-inline">
            <input type="password" name="oldPassword" required lay-verify="required" placeholder="请输入密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新密码</label>
        <div class="layui-input-inline">
            <input type="password" name="newPassword" required lay-verify="required" placeholder="请输入密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updatePassword">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelPwd">取消</button>
        </div>
    </div>
</form>
<!-- 编辑分类表单 -->
<form class="layui-form" action="" id="update-category" lay-filter="update-category"
      style="display: none;padding: 10px">
    <input type="hidden" name="id">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline">
            <input type="text" name="name" id="categoryName" required lay-verify="required" placeholder="请输入名称"
                   autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updateCategory">立即提交</button>
            <button type="button" class="layui-btn layui-btn-danger" id="deleteCategory">删除</button>
        </div>
    </div>
</form>
<script src="/layui/layui.js"></script>
<script>
    //JavaScript代码区域
    layui.use(['element', 'jquery', 'layer', 'form', 'upload'], function () {
        var element = layui.element;
        var $ = layui.$;
        var layer = layui.layer;
        var form = layui.form;
        var upload = layui.upload;

        //执行实例
        var uploadInst = upload.render({
            elem: '#import' //绑定元素
            , accept: 'file'
            , acceptMime: 'file/xml'
            , exts: 'xml'
            , url: '/favorites/upload' //上传接口
            , done: function (result) {
                //上传完毕回调
                if (result.code == 0) {
                    layer.closeAll();
                    loadList();
                } else {
                    layer.msg('导入失败', {icon: 5});
                }
            }
            , error: function () {
                layer.msg('导入失败', {icon: 5});
            }
        });

        $("#export").click(function () {
            window.location.href = "/favorites/export";
        });
        $("#cancelPwd").click(function () {
            layer.closeAll();
        });
        $("#cancelAddFavorites").click(function () {
            layer.closeAll();
        });
        $("#importOrExportBtn").click(function () {
            layer.open({
                type: 1,
                title: "导入收藏夹",
                area: '400px',
                content: $('#importOrExport') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
        });
        // 智能按钮
        $("#smartBtn").click(function () {
            layer.prompt({"title": "添加收藏(url)"}, function (value, index, elem) {
                $.ajax({
                    type: "POST",
                    url: "/favorites/smartAdd",
                    data: JSON.stringify({"url": value}),
                    contentType: 'application/json;charset=utf-8',
                    dataType: "json",
                    success: function (result) {
                        if (result.code == 0) {
                            // 新增分类
                            loadList();
                        }
                    }
                });
                layer.close(index);
            });
        });
        // 关闭搜索
        $("#search_close").click(function () {
            $(this).hide();
            if ($("#search_name").val() != "") {
                $("#search_name").val("");
                loadList();
            }
        });
        // 监听输入框
        $("#search_name").keydown(function (event) {
            if (event.key === "Enter") {
                var name = $(this).val();
                if (name == "") {
                    loadList();
                } else {
                    $.ajax({
                        type: "GET",
                        url: "/favorites/search",
                        data: {"name": name},
                        dataType: "json",
                        success: function (result) {
                            if (result.code == 0) {
                                var html = '';
                                html += '<ul class="favorites">';
                                $.each(result.data, function (i, f) {
                                    html += '<li class="layui-anim layui-anim-scale" onclick="openUrl(\'' + f.url + '\')">';
                                    html += '   <div class="favorites-bg">';
                                    html += '       <img src="' + f.icon + '" onerror="this.src=\'/images/default.png\'" />';
                                    html += '   </div>';
                                    html += '   <p title="' + f.name + '">' + f.name + '</p>';
                                    html += '   <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical" data-id="' + f.id + '"></i>';
                                    html += '</li>';
                                });
                                html += '</ul>';
                                $("#main").empty().append(html);
                            }
                        }
                    });
                }
            }
        }).on("input", function () {
            if ($(this).val() != "") {
                $("#search_close").show();
            } else {
                $("#search_close").hide();
            }
        });
        // 打开新窗口
        window.openUrl = function (url) {
            try {
                var u = new URL(url);
                window.open(u.href);
            } catch (err) {
                layer.msg('此链接无效', {icon: 7});
            }
        };
        // 编辑分类
        window.editCategory = function (obj) {
            layer.open({
                type: 1,
                title: "修改分类",
                area: '400px',
                content: $('#update-category') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "/category/" + $(obj).parent().attr("data-id"),
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-category", { //formTest 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
                            "id": data.id // "name": "value"
                            , "name": data.name
                        });
                        //禁用系统分类
                        if (data.isSystem == 1) {
                            $("#categoryName").attr("disabled", true);
                        } else {
                            $("#categoryName").removeAttr("disabled");
                        }
                    }
                }
            });
        };
        // 新增分类
        $("#addCategoryBtn").click(function () {
            layer.prompt({"title": "添加分类"}, function (value, index, elem) {
                $.ajax({
                    type: "POST",
                    url: "/category",
                    data: JSON.stringify({"name": value}),
                    contentType: 'application/json;charset=utf-8',
                    dataType: "json",
                    success: function (result) {
                        if (result.code == 0) {
                            // 新增分类
                            loadList();
                        }
                    }
                });
                layer.close(index);
            });
        });
        // 修改密码
        $("#changePwd").click(function () {
            layer.open({
                type: 1,
                title: "修改密码",
                area: '400px',
                content: $('#password') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
        });
        // 登出
        $("#logout").click(function () {
            $.ajax({
                type: "GET",
                url: "/user/logout",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        window.location.href = "/login.html";
                    }
                }
            });
        });
        // 加载数据
        window.loadList = function () {
            $.ajax({
                type: "GET",
                url: "/favorites/list",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        // 加载数据
                        var html = '';
                        $.each(result.data, function (i, c) {
                            html += '<fieldset class="layui-elem-field" data-id="' + c.id + '">';
                            html += '   <legend onclick="editCategory(this)">' + c.name + '</legend>';
                            html += '       <ul class="favorites">';
                            $.each(c.favorites, function (i, f) {
                                html += '           <li class="layui-anim layui-anim-scale" onclick="openUrl(\'' + f.url + '\')">';
                                html += '               <div class="favorites-bg">';
                                html += '                   <img src="' + f.icon + '" onerror="this.src=\'/images/default.png\'" />';
                                html += '               </div>';
                                html += '               <p title="' + f.name + '">' + f.name + '</p>';
                                html += '               <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical" data-id="' + f.id + '"></i>';
                                html += '           </li>';
                            });
                            html += '           <li class="layui-anim layui-anim-scale" onclick="addFavorites(' + c.id + ')">';
                            html += '               <div class="favorites-bg"><i class="add-icon layui-icon layui-icon-add-1"></i></div>';
                            html += '               <p title="添加收藏">添加收藏</p>';
                            html += '           </li>';
                            html += '       </ul>';
                            html += '</fieldset>';
                        });
                        $("#main").empty().append(html);
                    }
                }
            });
        };
        // 添加收藏
        window.addFavorites = function (categoryId) {
            layer.open({
                type: 1,
                title: "添加收藏",
                area: '400px',
                content: $('#add-favorites') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
            // 表单赋值
            form.val("add-favorites", { //formTest 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
                "name": "" // "name": "value"
                , "url": ""
                , "categoryId": categoryId
            });
        };
        // 删除收藏
        $("#deleteFavorites").click(function () {
            var data = form.val("update-favorites");
            $.ajax({
                type: "GET",
                url: "/favorites/delete/" + data.id,
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
        });
        // 删除分类
        $("#deleteCategory").click(function () {
            var data = form.val("update-category");
            $.ajax({
                type: "GET",
                url: "/category/delete/" + data.id,
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        // 删除分类
                        $("fieldset[data-id='" + data.id + "']").remove();
                    } else {
                        layer.msg(result.msg, {icon: 2});
                    }
                }
            });
        });
        // 编辑收藏
        window.editFavorites = function (obj, e) {
            window.event ? window.event.cancelBubble = true : e.stopPropagation();//阻止冒泡
            layer.open({
                type: 1,
                title: "修改收藏",
                skin: 'to-fix-select',
                area: '400px',
                content: $('#update-favorites') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "/favorites/" + $(obj).attr("data-id"),
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-favorites", { //formTest 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
                            "id": data.id // "name": "value"
                            , "categoryId": data.categoryId
                            , "name": data.name
                            , "url": data.url
                        });
                    }
                }
            });
        };
        //监听提交
        form.on('submit(addFavorites)', function (data) {
            $.ajax({
                type: "POST",
                url: "/favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
            return false;
        });
        //监听提交
        form.on('submit(updateFavorites)', function (data) {
            $.ajax({
                type: "POST",
                url: "/favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
            return false;
        });
        //监听提交
        form.on('submit(updateCategory)', function (data) {
            $.ajax({
                type: "POST",
                url: "/category",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
            return false;
        });
        //监听提交
        form.on('submit(updatePassword)', function (data) {
            $.ajax({
                type: "POST",
                url: "/user/password",
                data: data.field,
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        layer.msg('修改成功', {icon: 6});
                        // 退出
                        setTimeout(function () {
                            $("#logout").trigger("click");
                        }, 1000);
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        $(function () {
            // 加载数据
            loadList();
            // 加载用户信息
            $.ajax({
                type: "GET",
                url: "/user/info",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let username = result.data.username;
                        $("#username").text(username.substring(0, 4));
                    }
                }
            });
            // 加载分类
            $.ajax({
                type: "GET",
                url: "/category/list",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        var html = '';
                        $.each(result.data, function (i, c) {
                            html += '<option value="' + c.id + '">' + c.name + '</option>';
                        });
                        $("#categoryId").empty().append(html);
                    }
                }
            });
        });
    });
</script>
</body>
</html>