<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>网络收藏夹|首页</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="layui/css/layui.css">
    <style>
        .layui-blue {
            color: #1e9fff !important;
            text-decoration: underline;
        }

        /* 解决没有src属性时出现的边框 */
        img[src=""], img:not([src]){
            opacity:0;
        }

        /* 解决弹出框中select显示难看 */
        .to-fix-select .layui-layer-content {
            overflow: visible !important;
        }

        .layui-header {
            background-color: #0A0E11 !important;
        }

        #userImg {
            font-size: 18px;
            font-weight: bold;
            margin-right: 5px;
            vertical-align: middle;
        }

        .search-input {
            z-index: 999;
            position: absolute;
            top: 16px;
            left: 150px;
            width: 160px;
            height: 30px;
        }

        .search-input input {
            height: 100%;
            font-size: 12px;
            border: none;
            background-color: #161a1d;
            color: #b2b2b2;
            padding-left: 24px;
            padding-right: 26px;
        }

        .search-input .search-close {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 20px;
            color: #666;
            display: none;
            cursor: pointer;
        }

        .category{
            margin: 10px 0 20px;
        }

        .category .title{
            margin-left: 20px;
            padding: 0 10px;
            font-size: 20px;
            font-weight: 300;
            border-left: 6px solid #009688;
            cursor: pointer;
            display: inline-block;
        }

        .favorites {
            display: flex;
            flex-wrap: wrap;
            overflow: hidden;
            padding: 10px;
        }

        .favorites li {
            display: flex;
            align-items: center;
            flex-direction: column;
            position: relative;
            padding: 10px 16px;
            cursor: pointer;
            border-radius: 4px;
        }

        .favorites li .favorites-bg {
            width: 80px;
            height: 80px;
            line-height: 80px;
            text-align: center;
            border-radius: 50%;
        }

        .favorites li .favorites-bg img {
            width: 50%;
            height: 50%;
            border: 0;
        }

        .favorites li.active {
            background-color: #fafafa;
        }

        .favorites li:hover {
            background-color: #fafafa;
        }

        .favorites li:hover .favorites-bg {
            background-color: #f0f0f5;
        }

        .favorites li p {
            width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 10px;
            text-align: center;
        }

        .favorites li .action-icon {
            position: absolute;
            top: 4px;
            right: 0;
            font-size: 20px;
            font-weight: bold;
            color: #606266;
            display: none;
            width: 26px;
            height: 26px;
            line-height: 26px;
            text-align: center;
        }

        .favorites li:hover .action-icon {
            display: block;
        }

        /** 开源信息 **/
        .open-source {
            font-size: 12px;
            text-align: center;
        }

        .style-select{
            position: absolute;
            top: 12px;
            right: 240px;
        }

        .style-select .layui-form-switch{
            border-color: #161a1d;
            background-color: #161a1d;
        }

        /** 书签模式 **/
        .bookmark .favorites li{
            flex-direction: row !important;
        }

        .bookmark .favorites li .favorites-bg{
            width: 16px !important;
            height: 16px !important;
            line-height: 16px !important;
            text-align: center !important;
            border-radius: 0 !important;
        }

        .bookmark .favorites li .favorites-bg img{
            width: 100% !important;
            height: 100% !important;
            border: 0 !important;
            vertical-align: baseline !important;
        }

        .bookmark .favorites li:hover .favorites-bg{
            background-color: transparent !important;
        }

        .bookmark .favorites li p{
            width: 300px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            margin-top: 0 !important;
            text-align: left !important;
            margin-left: 10px !important;
            line-height: 30px !important;
            padding-right: 4px !important;
        }

        .bookmark .favorites li .action-icon{
            top: 12px !important;
            right: 4px !important;
        }

        /* 目录 */
        .catalog {
            padding: 10px 20px 30px 20px;
        }

        .catalog ul {
            display: flex;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .catalog li {
            height: 20px;
            line-height: 20px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 400;
            border-radius: 4px;
            background: #f2f4f6;
            color: #6a6a6a;
            margin-right: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        .catalog li:hover{
            color: #fff !important;
            background-color: #009688 !important;
            transition: 0.2s;
        }

        .catalog li.layui-this {
            color: #6a6a6a !important;
            background-color: #e0e0e0 !important;
            transition: 0.2s;
        }

        .notFoundDiv {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .notFoundDiv img {
            width: 100px;
            height: 100px;
            display: block;
            margin: 0 auto;
        }

        .notFoundDiv span{
            display: block;
            text-align: center;
            font-size: 24px;
            color: #c2c2c2;
            margin-top: 20px;
        }

        /* 过渡动画 */
        .lGDtb {
          width: 100px;
          height: 30px;
          text-align: center;
          font-size: 10px;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }

        .ljZkoB {
          background-color: rgb(255, 87, 34);
          height: 100%;
          width: 6px;
          display: inline-block;
          margin-left: 5px;
          animation: 1.2s ease-in-out -1.2s infinite normal none running cTRFYZ;
        }

        .gPySoS {
          background-color: rgb(255, 87, 34);
          height: 100%;
          width: 6px;
          display: inline-block;
          margin-left: 5px;
          animation: 1.2s ease-in-out -1.1s infinite normal none running cTRFYZ;
        }

        .dVkzjP {
          background-color: rgb(255, 87, 34);
          height: 100%;
          width: 6px;
          display: inline-block;
          margin-left: 5px;
          animation: 1.2s ease-in-out -1s infinite normal none running cTRFYZ;
        }

        .UdOCq {
          background-color: rgb(255, 87, 34);
          height: 100%;
          width: 6px;
          display: inline-block;
          margin-left: 5px;
          animation: 1.2s ease-in-out -0.9s infinite normal none running cTRFYZ;
        }

        .bnWJxh {
          background-color: rgb(255, 87, 34);
          height: 100%;
          width: 6px;
          display: inline-block;
          margin-left: 5px;
          animation: 1.2s ease-in-out -0.8s infinite normal none running cTRFYZ;
        }

        @keyframes cTRFYZ {

          0%,
          40%,
          100% {
            transform: scaleY(0.4);
          }

          20% {
            transform: scaleY(1);
          }
        }

        .search-items {
            position: absolute;
            top: 30px;
            left: 0;
            width: 100%;
            background: #161a1d;
            color: #b2b2b2;
            border-radius: 0 0 4px 4px;
            display: none;
        }

        .search-items li {
            padding-left: 10px;
            padding-right: 26px;
            cursor: pointer;
            line-height: 26px;
            font-size: 12px;
            position: relative;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            word-break: break-all;
        }

        .search-items li:last-child {
            margin-bottom: 6px;
        }

        .search-items li .history-close {
            color: #fff;
            font-size: 12px;
            position: absolute;
            top: 0;
            right: 8px;
            display: none;
            font-weight: bold;
        }

        .search-items li.hover-in .history-close {
            display: block;
        }

        .search-items li.hover-in {
		    background: #5fb878;
            color: #fff;
		}

		#slideBtn {
		    display: inline-block;
		    width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            cursor: pointer;
            font-size: 20px;
            background-color: #393D49;
            color: #fff;
            border-radius: 2px;
            opacity: .95;
            margin-right: 10px;
            margin-bottom: 10px;
		}

		#slideBtn:hover {
		    opacity: .8;
		}

		.url_loading {
		    color: #009688;
		    font-size: 22px;
		    font-weight: bold;
		    margin-top: 6px;
		}

		.tips-icon {
            margin-top: 8px;
            display: inline-block;
            font-size: 18px;
            color: #5e6d82;
            cursor: pointer;
		}

		#loadingDiv {
		    z-index: 2147483647;
		    position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display:none;
		}

		.url-copy-btn {
		    margin-top: 8px;
		    border-color: #FF5722!important;
		    color: #FF5722!important;
		}

		.backupList .layui-form-checkbox{
            width: 104px;
            overflow: hidden;
		}

		/*修改提示框*/
        #myTitle {
            z-index: 9999999;
            position: absolute;
            color: #ffffff;
            max-width: 160px;
            font-size: 14px;
            padding: 4px;
            background: rgba(40, 40, 40, 0.8);
            border: solid 1px #e9f7f6;
            border-radius:5px;
        }

        #notice {
            display:none;
            z-index: 999;
            position: absolute;
            top: 16px;
            left: 320px;
            min-width: 58px;
            height: 30px;
            color: #fff;
            line-height: 30px;
            font-size: 12px;
            padding: 0 15px;
            border-radius: 2px;
            cursor: pointer;
            overflow: hidden;
            background-image: linear-gradient(to right,#359FD4,#36B5C8,#25D8AB);
        }

        #notice cite{
            font-style: normal;
        }

        /* 目录搜索 */
        .catalog-search {
            position: relative;
            height: 30px;
        }

        .catalog-search input {
            height: 100%;
            font-size: 12px;
            padding-left: 26px;
            padding-right: 26px;
        }

        .catalog-search .catalog-search-close {
            position: absolute;
            top: 5px;
            right: 4px;
            font-size: 20px;
            color: #666;
            display: none;
            cursor: pointer;
        }

        .catalog-search .catalog-search-icon {
            position: absolute;
            top: 8px;
            left: 6px;
            font-size: 14px;
            color: #999;
            cursor: pointer;
        }

        .layui-textarea {
            min-height: 70px;
        }

        .shortcut-mike {
            position: absolute;
            top: 8px;
            right: -30px;
            font-size: 22px;
            cursor: pointer;
            color: #5e6d82;
        }

        .search-mike {
            position: absolute;
            top: 6px;
            left: 6px;
            font-size: 16px;
            color: #999;
            cursor: pointer;
        }

        .positionNav {
            padding-left: 20px;
            padding-bottom: 4px;
        }

        .deleteFastNav {
            top: 0px !important;
            font-size: 18px !important;
            font-weight: normal !important;
        }

        #fastNav .favorites {
            margin-bottom: 24px !important;
        }

        .local-tip {
            display: inline-block;
            font-size: 18px;
            color: #5e6d82;
            cursor: pointer;
            margin-left: 6px;
            vertical-align: -34%;
        }

        #cleanData {
            cursor: pointer;
            color: #1e9fff;
            display: block;
            width: 100px;
            margin: 0 auto;
            margin-top: 10px;
        }

        #addCategoryIcon {
            margin-top: 8px;
            display: inline-block;
            font-size: 20px;
            color: #5e6d82;
            cursor: pointer;
        }
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo" style="width: 150px;cursor: pointer;" onclick="window.location.reload();">
            <img src="images/logo.svg" style="margin-right: 6px;width: 24px;vertical-align: text-top;">网络收藏夹
        </div>
        <div class="search-input">
            <i id="searchMike" class="layui-icon layui-icon-mike search-mike"></i>
            <input type="text" id="search_name" name="search_name" placeholder="搜索/输入快捷指令" autocomplete="off"
                   class="layui-input">
            <i id="search_close" class="layui-icon layui-icon-close-fill search-close layui-anim layui-anim-fadein" style="display:none;"></i>
            <ul class="search-items layui-anim layui-anim-fadein"></ul>
        </div>
        <div id="notice" onclick="showNotice('click')">
            <cite>公告</cite>
            <span class="layui-badge-dot" style="margin-left: 4px;"></span>
        </div>
        <div class="layui-form style-select" lay-filter="styleSelect">
            <div class="layui-input-inline">
                <input type="checkbox" name="viewStyle" lay-skin="switch" lay-text="书签模式|常规模式" lay-filter="viewStyle">
            </div>
        </div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item"><a href="share.html">书签库</a></li>
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <i class="layui-icon layui-icon-user" id="userImg"></i>
                    <span id="username">默认</span>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:;" id="changePwd">修改密码</a></dd>
                    <dd><a href="javascript:;" id="changeEmail">修改邮箱</a></dd>
                    <dd><a href="javascript:;" id="recycle">管理收藏</a></dd>
                    <dd><a href="javascript:;" id="importOrExportBtn">导入与备份</a></dd>
                    <dd><a href="javascript:;" id="logout">安全退出</a></dd>
                </dl>
            </li>
        </ul>
    </div>

    <div class="layui-body" id="layuiBody" style="padding: 15px 0;left: 0;">
        <!-- 内容主体区域 -->
        <div id="starDiv"></div>
        <div id="main"><div id="categoryList"></div></div>
        <div id="searchDiv" style="display:none;"></div>
        <div id="positionDiv" style="display:none;">
            <div class="positionNav">
                <span class="layui-breadcrumb" lay-separator="/">
                <a href="javascript:window.location.reload();">首页</a>
                <a><cite>分类</cite></a>
            </span>
            </div>
            <div id="positionData"></div>
        </div>
    </div>
    <div class="layui-footer" style="left: 0;">
        <p class="open-source">© 2020 网络收藏夹 | <a href="https://gitee.com/wangxiaoyuan_2019/web-favorites.git" target="_blank">网站源码</a> | QQ群：<a href="https://jq.qq.com/?_wv=1027&k=uMr09FnI" target="_blank">972265056</a></p>
    </div>
</div>
<!-- 操作按钮 -->
<div class="layui-btn-container layui-anim layui-anim-fadein" style="position: fixed;left: 15px;bottom: 44px;z-index: 99999;">
    <span id="slideBtn" class="layui-icon layui-icon-right"></span>
    <button type="button" class="layui-btn layui-btn-sm" id="addCategoryBtn">添加分类</button>
    <button type="button" class="layui-btn layui-btn-sm" id="addFavoritesBtn">添加收藏</button>
    <button type="button" class="layui-btn layui-btn-sm" id="fastNavBtn">快捷导航</button>
</div>
<!-- 加载动画 -->
<div id="loadingDiv">
    <div class="lGDtb">
        <div class="ljZkoB"></div>
        <div class="gPySoS"></div>
        <div class="dVkzjP"></div>
        <div class="UdOCq"></div>
        <div class="bnWJxh"></div>
    </div>
</div>
<!-- 找不到结果 -->
<div id="notFoundDiv" class="notFoundDiv">
    <img src="images/no_data.svg" alt="">
    <span>找不到结果</span>
</div>
<!-- 导入/备份 -->
<div class="layui-tab layui-tab-brief" id="importOrExport" style="display: none;">
    <ul class="layui-tab-title">
        <li class="layui-this">导入</li>
        <li>备份</li>
    </ul>
    <div class="layui-tab-content" style="text-align: center;">
        <div class="layui-tab-item layui-show">
            <div style="margin-top: 30px;">
                <button type="button" class="layui-btn" id="import">导入收藏夹</button>
                <button style="vertical-align: bottom;margin-left: 5px;" type="button" class="layui-btn layui-btn-sm layui-btn-warm" id="importLocal">从浏览器导入</button>
                <i class="layui-icon layui-icon-tips local-tip" lay-title="请将书签从其他浏览器导出，存至本地html文件，再将文件上传至服务器"></i>
            </div>
            <div style="margin: 20px 0;color: #5e6d82;line-height: 32px;font-size: 12px;">请将 "export.xml" 文件上传至服务器</div>
        </div>
        <div class="layui-tab-item">
            <div style="margin-top: 30px;margin-bottom: 10px;">
                <button type="button" class="layui-btn" id="export">备份收藏夹</button>
                <span id="cleanData">清除所有数据</span>
            </div>
            <div class="layui-form" lay-filter="userData">
                <div class="layui-form-item">
                    <label class="layui-form-label">备份数据：</label>
                    <div class="layui-input-block backupList" style="text-align: left;">
                        <input type="checkbox" id="favorites" name="favorites" title="收藏(0)" lay-skin="primary" checked>
                        <input type="checkbox" id="moment" name="moment" title="瞬间(0)" lay-skin="primary" checked>
                        <input type="checkbox" id="task" name="task" title="日程(0)" lay-skin="primary" checked>
                        <input type="checkbox" id="search" name="search" title="搜索(0)" lay-skin="primary" checked>
                        <input type="checkbox" id="navigation" name="navigation" title="导航(0)" lay-skin="primary" checked>
                        <input type="checkbox" id="memorandum" name="memorandum" title="备忘录(0)" lay-skin="primary" checked>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 添加收藏表单 -->
<form class="layui-form" action="" id="add-favorites" lay-filter="add-favorites" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-inline" style="width: 210px;">
            <textarea name="url" id="url_input" required lay-verify="required|url" placeholder="请输入地址"
                      class="layui-textarea"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="text" name="name" id="name_input" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
        <i id="url_loading" class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop url_loading" style="display:none;"></i>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">分类</label>
        <div class="layui-input-inline" style="width: 210px;">
            <select name="categoryId" lay-verify="required" lay-search>
            </select>
        </div>
        <i id="addCategoryIcon" class="layui-icon layui-icon-add-circle"></i>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="addFavorites">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelAddFavorites">取消</button>
        </div>
    </div>
</form>
<!-- 添加快捷导航 -->
<form class="layui-form" action="" id="add-fastNav" lay-filter="add-fastNav" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-inline" style="width: 210px;">
            <textarea name="url" id="nav_url_input" required lay-verify="required|url" placeholder="请输入地址"
                      class="layui-textarea"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="text" name="name" id="nav_name_input" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
        <i id="nav_url_loading" class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop url_loading" style="display:none;"></i>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="addFastNav">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelAddFastNav">取消</button>
        </div>
    </div>
</form>
<!-- 编辑收藏表单 -->
<form class="layui-form" action="" id="update-favorites" lay-filter="update-favorites"
      style="display: none;padding: 10px 0;">
    <input type="hidden" name="id" id="favoritesId">
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-inline" style="width: 210px;">
            <textarea name="url" id="edit_url_input" required lay-verify="required|url" placeholder="请输入地址"
                      class="layui-textarea"></textarea>
        </div>
        <button type="button" id="edit_url_input_copy" class="layui-btn layui-btn-primary layui-btn-xs url-copy-btn" data-clipboard-target="#edit_url_input">复制</button>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="text" name="name" id="edit_name_input" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
        <i id="edit_url_loading" class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop url_loading" style="display:none;"></i>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">分类</label>
        <div class="layui-input-inline" style="width: 210px;">
            <select name="categoryId" lay-verify="required" lay-search>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">排序</label>
        <div class="layui-input-inline" style="width: 120px;">
            <input type="text" name="sort" lay-verify="sortNum" placeholder="请输入数值"
                   autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux">数值越大越靠前</div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">标记</label>
        <div class="layui-input-inline" style="width: 50px;">
            <input type="checkbox" name="star" lay-skin="switch" value="1" lay-filter="starSwitch">
        </div>
        <div class="layui-form-mid layui-word-aux">标记为常用网址</div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">App</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="text" name="schemaName" placeholder="请输入app schema名称"
                   autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">快捷指令</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="text" name="shortcut" lay-verify="shortcut" placeholder="例如：打开...或Open..." autocomplete="off"
                   class="layui-input">
            <span style="color: #ff5722;font-size: 12px;margin-top: 5px;display: block;">温馨提示：配合语音输入效果更佳哦</span>
            <i id="shortcutMike" class="layui-icon layui-icon-mike shortcut-mike"></i>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">分享</label>
        <div class="layui-input-inline" style="width: 50px;">
            <input type="checkbox" name="isShare" lay-skin="switch" value="1" lay-filter="shareSwitch">
        </div>
        <div class="layui-form-mid layui-word-aux">分享到书签库</div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="updateFavorites">立即提交</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="deleteFavorites">删除</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-warm" id="settingPwd">管理密码</button>
        </div>
    </div>
</form>
<!-- 管理密码表单 -->
<form class="layui-form" action="" id="setting-pwd" lay-filter="setting-pwd"
      style="display: none;padding: 10px">
    <input type="hidden" name="id" id="pwdId">
    <input type="hidden" name="favoritesId">
    <div class="layui-form-item">
        <label class="layui-form-label">登录账号</label>
        <div class="layui-input-inline" style="width: 160px;">
            <input type="text" name="account" id="account" placeholder="请输入账号" autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-inline">
            <button type="button" id="accountCopy" class="layui-btn layui-btn-warm layui-btn-xs" style="margin-top:8px" data-clipboard-target="#account">复制</button>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">登录密码</label>
        <div class="layui-input-inline" style="width: 160px;">
            <input type="text" name="password" id="password" placeholder="请输入密码" autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-inline">
            <button type="button" id="passwordCopy" class="layui-btn layui-btn-warm layui-btn-xs" style="margin-top:8px" data-clipboard-target="#password">复制</button>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="savePwd">立即提交</button>
            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="unsetPwd">清除密码</button>
        </div>
    </div>
</form>
<!-- 修改密码表单 -->
<form class="layui-form" action="" id="passwordForm" lay-filter="passwordForm" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">旧密码</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="password" name="oldPassword" required lay-verify="required" placeholder="请输入旧密码"
                   autocomplete="off" class="layui-input">
        </div>
        <i class="layui-icon layui-icon-tips tips-icon" lay-title="忘记密码可在登录页面找回密码"></i>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新密码</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="password" name="newPassword" id="newPassword" required lay-verify="required" placeholder="请输入新密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">确认密码</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="password" name="confirmPassword" required lay-verify="required|confirmPassword" placeholder="再次确认新密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updatePassword">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelPwd">取消</button>
        </div>
    </div>
</form>
<!-- 修改邮箱表单 -->
<form class="layui-form" action="" id="emailForm" lay-filter="emailForm" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">新邮箱</label>
        <div class="layui-input-inline" style="width: 210px;">
            <input type="text" name="newEmail" id="newEmail" required lay-verify="required|email|exitEmail" placeholder="请输入邮箱"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">验证码</label>
        <div class="layui-input-inline" style="width:132px;">
            <input type="text" name="code" required lay-verify="required" placeholder="请输入验证码"
                   autocomplete="off" class="layui-input">
        </div>
        <input type="button" class="layui-btn layui-btn-sm layui-btn-danger" style="margin-top:4px;width: 68px;" onclick="sendEmailCode(this)" value="点击获取">
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updateEmail">立即提交</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelEmail">取消</button>
        </div>
    </div>
</form>
<!-- 编辑分类表单 -->
<form class="layui-form" action="" id="update-category" lay-filter="update-category"
      style="display: none;padding: 10px">
    <input type="hidden" name="id">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-inline" style="width: 228px;">
            <input type="text" name="name" id="categoryName" required lay-verify="required|category" placeholder="请输入名称"
                   autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">排序</label>
        <div class="layui-input-inline" style="width: 120px;">
            <input type="text" name="sort" id="categorySort" lay-verify="sortNum" placeholder="请输入数值"
                   autocomplete="off"
                   class="layui-input">
        </div>
        <div class="layui-form-mid layui-word-aux">数值越大越靠前</div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">模式</label>
        <div class="layui-input-inline" style="width: 50px;">
            <input type="checkbox" name="bookmark" lay-skin="switch" value="1" lay-filter="bookmarkSwitch">
        </div>
        <div class="layui-form-mid layui-word-aux">强制切换至书签模式</div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-sm" lay-submit lay-filter="updateCategory">立即提交</button>
            <button type="button" class="layui-btn layui-btn-danger layui-btn-sm" id="deleteCategory">删除分类</button>
            <button type="button" class="layui-btn layui-btn-warm layui-btn-sm" id="clean">清空收藏</button>
        </div>
    </div>
</form>
<!-- 目录 -->
<div id="catalog" class="catalog" style="display:none;">
    <div class="catalog-search">
        <i id="catalog_search_icon" class="layui-icon layui-icon-search catalog-search-icon"></i>
        <input type="text" id="catalog_search_name" name="catalog_search_name" placeholder="请输入分类名称" autocomplete="off"
               class="layui-input">
        <i id="catalog_search_close" class="layui-icon layui-icon-close-fill catalog-search-close layui-anim layui-anim-fadein" style="display:none;"></i>
    </div>
    <ul id="catalogList"></ul>
</div>
<script src="layui/jquery-3.1.1.min.js"></script>
<script src="layui/layui.js"></script>
<script src="layui/clipboard.min.js"></script>
<script src="layui/md5.min.js"></script>
<script>
    //JavaScript代码区域
    layui.use(['element', 'layer', 'form', 'upload','flow','util'], function () {
        var element = layui.element;
        var layer = layui.layer;
        var form = layui.form;
        var upload = layui.upload;
        var flow = layui.flow;
        var util = layui.util;

        var favoritesLimit = 40;// 显示个数限制
        var navigationLimit = 6;// 显示个数限制
        var indexPageSize = 10;// 分页大小

        var currentPage = 1;

        var indexMap = new Map();// 弹出层索引容器

        // 执行加载动画
        $("#loadingDiv").fadeIn();

        // 点击空白关闭
        $(document).on("click", function(e) {
            var _conss = $('.search-input');//点击的容器范围
            if (!_conss.is(e.target) && _conss.has(e.target).length === 0) {
                $(".search-items").hide();
                $("#search_close").hide();
            }
        });

        // jQuery全局拦截器
        $(document).ajaxSuccess(function(event,xhr,options){
            var result = xhr.responseJSON;
            if(result != undefined && result.code == "401"){
                window.location.href= "login.html";
            }
        });

        // 根据数组的下标，删除该下标的元素
        Array.prototype.remove = function(val) {
            var index = this.indexOf(val);
            if (index > -1) {
                this.splice(index, 1);
            }
        };

        flow.load({
            elem: '#categoryList'
            ,scrollElem: '#layuiBody'
            ,isLazyimg: true
            ,end: ' '
            ,mb: 400
            ,done: function(page, next){
              // 校正page值
              if(page > 1 && page <= currentPage){
                page = ++currentPage;
                next('',true,currentPage);
              }
              var lis = [];
              $.ajax({
                type: "GET",
                url: "favorites/list",
                data: {"pageNum":page, "pageSize":indexPageSize},
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if(page == 1){
                        $("#loadingDiv").fadeOut();
                    }
                    if (result.code == 0) {
                        // 加载数据
                        $.each(result.data.list, function (i, c) {
                            var html = '';
                            var bookmarkClass = c.bookmark==1?"bookmark":"";
                            html += '<div class="category ' + bookmarkClass + '" data-id="' + c.id + '">';
                            html += '   <div class="title" onclick="editCategory(this,event)">' + c.name + '</div>';
                            html += '   <ul class="favorites">';
                            if(c.favorites.length > 0) {
                                $.each(c.favorites, function (j, f) {
                                    html += '   <li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" data-schema="' + f.schemaName + '" onclick="openUrl(this)">';
                                    html += '       <div class="favorites-bg">';
                                    html += '           <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                                    html += '       </div>';
                                    html += '       <p class="myToolTip" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</p>';
                                    html += '       <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                                    html += '   </li>';
                                    if(j == favoritesLimit - 1){
                                        html += '<li class="layui-anim layui-anim-fadein" onclick="moreFavorites(' + c.id + ')">';
                                        html += '   <div class="favorites-bg">';
                                        html += '       <img src="images/more.svg"/>';
                                        html += '   </div>';
                                        html += '   <p title="显示更多">显示更多</p>';
                                        html += '</li>';
                                        return false;
                                    }
                                });
                            } else {
                                html += '<li class="layui-anim layui-anim-fadein" onclick="addFavorites(' + c.id + ')">';
                                html += '   <div class="favorites-bg">';
                                html += '       <img src="images/add.svg"/>';
                                html += '   </div>';
                                html += '   <p title="添加网址">添加网址</p>';
                                html += '</li>';
                            }
                            html += '   </ul>';
                            html += '</div>';
                            lis.push(html);
                        });
                        next(lis.join(''), page < result.data.pages);
                    }
                },
                error: function(){
                    layer.msg("服务器异常", {icon: 2});
                }
              });
            }
        });

        // 固定块
        util.fixbar({
            top: true
            ,bar1: '&#xe615;'// 搜索
            ,bar2: '&#xe60a;'// 备忘录
            ,bar3: '&#xe68d;'// 瞬间
            ,bar4: '&#xe637;'// 日历
            ,bar5: '&#xe681;'// 文件
            ,scrollElem: '#layuiBody'
            ,bgcolor: '#393D49'
            ,css: {right: 30, bottom: 50}
            ,click: function(type){
                if(type === 'bar1'){
                    window.location.href = "search.html";
                }else if(type === 'bar2'){
                    window.location.href = "memorandum.html";
                }else if(type === 'bar3'){
                    window.location.href = "moment.html";
                }else if(type === 'bar4'){
                    window.location.href = "calendar.html";
                }else if(type === 'bar5'){
                    window.location.href = "file.html";
                }
            }
            ,mouseenter: function(type,ele){
                if(type === 'top'){
                    layer.tips('回到顶部', ele, {tips: 4});
                }else if(type === 'bar1'){
                    layer.tips('搜索', ele, {tips: 4});
                }else if(type === 'bar2'){
                    layer.tips('备忘录', ele, {tips: 4});
                }else if(type === 'bar3'){
                    layer.tips('瞬间', ele, {tips: 4});
                }else if(type === 'bar4'){
                    layer.tips('日程', ele, {tips: 4});
                }else if(type === 'bar5'){
                    layer.tips('文件', ele, {tips: 4});
                }
            }
            ,mouseleave: function(ele,type){
                layer.closeAll('tips');
            }
        });

        //执行实例
        var uploadInst = upload.render({
            elem: '#import' //绑定元素
            , accept: 'file'
            , acceptMime: 'file/xml'
            , exts: 'xml'
            , url: 'favorites/import' //上传接口
            , headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")}
            , before: function(obj){
                layer.close(indexMap.get('#importOrExport')); //关闭弹层
                layer.load(); //上传loading
            }
            , done: function (result) {
                layer.closeAll('loading'); //关闭loading
                if (result.code == 0) {
                    window.location.reload();//刷新
                } else {
                    layer.msg(result.msg, {icon: 5});
                }
            }
            , error: function () {
                layer.closeAll('loading'); //关闭loading
                layer.msg('导入失败', {icon: 5});
            }
        });

        //执行实例
        var uploadInst = upload.render({
            elem: '#importLocal' //绑定元素
            , accept: 'file'
            , acceptMime: 'file/html'
            , exts: 'html'
            , url: 'favorites/importHtml' //上传接口
            , headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")}
            , before: function(obj){
                layer.close(indexMap.get('#importOrExport')); //关闭弹层
                layer.load(); //上传loading
            }
            , done: function (result) {
                layer.closeAll('loading'); //关闭loading
                if (result.code == 0) {
                    window.location.reload();//刷新
                } else {
                    layer.msg(result.msg, {icon: 5});
                }
            }
            , error: function () {
                layer.closeAll('loading'); //关闭loading
                layer.msg('导入失败', {icon: 5});
            }
        });

        $("#shortcutMike").click(function(){
            layer.msg("该功能暂未开放");
        });

        $("#searchMike").click(function(){
            layer.msg("该功能暂未开放");
        });

        // 清除密码
        $("#unsetPwd").click(function(){
            var passwordId = $("#pwdId").val();
            if(passwordId == ""){
                layer.msg('未设置密码');
                return false;
            }
            layer.confirm('确认清除吗?', function(index){
                layer.close(index);

                layer.load();
                $.ajax({
                    type: "DELETE",
                    url: "password/" + passwordId,
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        layer.closeAll('loading');
                        if (result.code == 0) {
                            layer.msg('操作成功', {icon: 6});
                            // 重置表单
                            form.val("setting-pwd", {
                                "id": ""
                                , "account": ""
                                , "password": ""
                            });
                        } else {
                           layer.msg(result.msg, {icon: 5});
                        }
                    }
                });
            });
        });

        $("#catalog_search_name").on('input',function(){
            $("#catalog_search_close").show();
            var name = $(this).val();
            $("#catalogList").children("li").each(function(i,item){
                if($(item).text().indexOf(name) != -1){
                    $(item).show();
                }else{
                    $(item).hide();
                }
            });
        });

        // 关闭搜索
        $("#catalog_search_close").click(function () {
            $("#catalog_search_name").val("").trigger("input");
            $(this).hide();
        });

        $("#edit_url_input").on('input',function(){
            var url = $(this).val();
            if(url.indexOf("https://") == 0 || url.indexOf("http://") == 0){
                $("#edit_name_input").addClass("layui-disabled").attr("disabled",true);
                $("#edit_url_loading").show();
                // 请求后台解析url
                $.ajax({
                    type: "GET",
                    url: "favorites/url",
                    data: {"url": url},
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        $("#edit_name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#edit_url_loading").hide();

                        if (result.code == 0 && result.data != "") {
                            $("#edit_name_input").val(result.data);
                        }
                    },
                    error: function(){
                        $("#edit_name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#edit_url_loading").hide();
                    }
                });
            }
        });

        $("#url_input").on('input',function(){
            var url = $(this).val();
            if(url.indexOf("https://") == 0 || url.indexOf("http://") == 0){
                $("#name_input").addClass("layui-disabled").attr("disabled",true);
                $("#url_loading").show();
                // 请求后台解析url
                $.ajax({
                    type: "GET",
                    url: "favorites/url",
                    data: {"url": url},
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        $("#name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#url_loading").hide();

                        if (result.code == 0 && result.data != "") {
                            $("#name_input").val(result.data);
                        }
                    },
                    error: function(){
                        $("#name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#url_loading").hide();
                    }
                });
            }
        });

        $("#nav_url_input").on('input',function(){
            var url = $(this).val();
            if(url.indexOf("https://") == 0 || url.indexOf("http://") == 0){
                $("#nav_name_input").addClass("layui-disabled").attr("disabled",true);
                $("#nav_url_loading").show();
                // 请求后台解析url
                $.ajax({
                    type: "GET",
                    url: "favorites/url",
                    data: {"url": url},
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        $("#nav_name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#nav_url_loading").hide();

                        if (result.code == 0 && result.data != "") {
                            $("#nav_name_input").val(result.data);
                        }
                    },
                    error: function(){
                        $("#nav_name_input").removeClass("layui-disabled").removeAttr("disabled",true);
                        $("#nav_url_loading").hide();
                    }
                });
            }
        });

        window.isMobile = function(){
            let info = navigator.userAgent;
            let agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPod", "iPad"];
            for(let i = 0; i < agents.length; i++){
                if(info.indexOf(agents[i]) >= 0) return true;
            }
            return false;
        };

        $("#settingPwd").click(function () {
            layer.open({
                type: 1,
                title: "管理登录此网站的密码",
                area: '360px',
                content: $('#setting-pwd')
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "password/fid/" + $("#favoritesId").val(),
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("setting-pwd", {
                            "id": data.id
                            , "favoritesId": data.favoritesId
                            , "account": data.account
                            , "password": data.password
                        });
                    } else {
                        form.val("setting-pwd", {
                            "id": ""
                            , "favoritesId": $("#favoritesId").val()
                            , "account": ""
                            , "password": ""
                        });
                    }
                }
            });
        });

        $("#export").click(function () {
            var favorites = $("#favorites").is(":checked")?"1":"0";
            var moment = $("#moment").is(":checked")?"1":"0";
            var task = $("#task").is(":checked")?"1":"0";
            var search = $("#search").is(":checked")?"1":"0";
            var navigation = $("#navigation").is(":checked")?"1":"0";
            var memorandum = $("#memorandum").is(":checked")?"1":"0";
            layer.close(indexMap.get('#importOrExport'));
            var url = "favorites/export?favorites=" + favorites + "&moment=" + moment + "&task=" + task + "&search=" + search + "&navigation=" + navigation + "&memorandum=" + memorandum;
            downloadFile('export.xml', url);
        });

        $("#cancelPwd").click(function () {
            layer.close(indexMap.get('#changePwd'));
        });

        $("#cancelEmail").click(function () {
            layer.close(indexMap.get('#changeEmail'));
        });

        $("#cancelAddFavorites").click(function () {
            layer.close(indexMap.get('#add-favorites'));
        });

        $("#cancelAddFastNav").click(function () {
            layer.close(indexMap.get('#add-fastNav'));
        });

        window.downloadFile = function(filename, url){
            $.ajax({
                url: url,
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                xhrFields: { responseType: "arraybuffer" },
                success: function(result){
                    var a = document.createElement('a');
                    a.download = filename;
                    a.style.display = 'none';
                    var blob = new Blob([result]);
                    a.href = URL.createObjectURL(blob);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },
                error: function(){
                    layer.msg('下载失败', {icon: 5});
                }
            });
        };

        // 搜索项绑定点击事件
        $(document).on('click', '.search-items li', function() {
            var text = $(this).text();
            $("#search_name").val(text).focus();
            $(this).parent().hide();
            searchFavorites(text);
        });

        $(document).on('click', '.search-items li .history-close', function(event) {
            event.stopPropagation();

            $(this).parent().remove();
            if($(".search-items").children().length === 0) $(".search-items").hide();

            var text = $(this).parent().text();
            var input_history = JSON.parse(localStorage.getItem("input_history"));
            if(input_history.indexOf(text) >= 0) {
                input_history.remove(text);
                localStorage.setItem("input_history", JSON.stringify(input_history));
            }
        });

        $("#importOrExportBtn").click(function () {
            var index = layer.open({
                type: 1,
                area: '400px',
                title: false,
                closeBtn: 0,
                content: $('#importOrExport')
            });
            indexMap.set('#importOrExport',index);
        });

        // 添加收藏
        $("#addFavoritesBtn").click(function () {
            var index = layer.open({
                type: 1,
                title: "添加收藏",
                skin: 'to-fix-select',
                area: '400px',
                content: $('#add-favorites')
            });
            indexMap.set('#add-favorites',index);
            // 表单赋值
            form.val("add-favorites", {
                "name": ""
                , "url": ""
            });
        });

        // 添加快捷导航
        window.addFastNav = function(){
            var index = layer.open({
                type: 1,
                title: "添加快捷导航",
                area: '400px',
                content: $('#add-fastNav')
            });
            indexMap.set('#add-fastNav',index);
            // 表单赋值
            form.val("add-fastNav", {
                "name": ""
                , "url": ""
            });
        };

        // 图片懒加载
        window.loadImg =  function loadImg(ele) {
            $(ele).find("img[lay-src]").each(function(i,item){
                var originUrl = item.getAttribute("src");
                var url = item.getAttribute("lay-src");
                var img = new Image();
                img.src = url;
                if(img.complete){
                  item.setAttribute('src', url);
                }
                img.onload = function(){
                  img.onload = null;
                  item.setAttribute('src', url);
                };
                img.onerror = function(e){
                  img.onerror = null;
                  item.setAttribute('src', originUrl);
                };
            });
        };

        // 快捷导航
        $("#fastNavBtn").click(function () {
            $.ajax({
                type: "GET",
                url: "quick-navigation/list",
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        // 加载数据
                        var html = '   <ul class="favorites">';
                        if(result.data.length > 0) {
                            $.each(result.data, function (j, f) {
                                html += '   <li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" data-schema="' + f.schemaName + '" onclick="openUrl(this,true)">';
                                html += '       <div class="favorites-bg">';
                                html += '           <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                                html += '       </div>';
                                html += '       <p class="myToolTip" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</p>';
                                html += '       <i onclick="deleteFastNav(this,event)" class="deleteFastNav action-icon layui-icon layui-icon-delete"></i>';
                                html += '   </li>';
                            });
                        }
                        var hideCss = result.data.length < navigationLimit ? '' : 'style="display:none"';
                        html += '       <li id="addFastNavBtn" class="layui-anim layui-anim-fadein" onclick="addFastNav()" '+ hideCss +'>';
                        html += '           <div class="favorites-bg">';
                        html += '               <img src="images/add.svg"/>';
                        html += '           </div>';
                        html += '           <p title="添加网址">添加网址</p>';
                        html += '       </li>';
                        html += '   </ul>';
                        // 弹出层
                        var width = parseInt($(window).width()) * 0.9;
                        width = (width >= 700 ? 700 : (width <= 360 ? 360 : width)) + 'px';
                        layer.open({
                            id: "fastNav",
                            type: 1,
                            title: "快捷导航",
                            area: width,
                            content: '<div>' + html + '</div>',
                            success: function(layero, index){
                                loadImg(layero);
                            }
                        });
                    }
                },
                error: function(){
                    layer.msg("服务器异常", {icon: 2});
                }
              });
        });

        // 关闭搜索
        $("#search_close").click(function () {
            $(this).hide();
            $("#search_name").val("");
            $(".search-items").hide();
            changeIndexMode();
        });

        // 搜索指令
        window.searchShortcut = function(name){
            layer.load();
            $.ajax({
                type: "GET",
                url: "favorites/shortcut?key=" + name,
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    $("#search_name").val("");
                    $("#search_close").hide();
                    if (result.code == 0) {
                        $(".favorites-li[data-id=" + result.data.id + "]").click();
                    }else{
                        layer.tips('未找到指令', '#search_name', {tips: 1});
                    }
                }
            });
        };

        // 切换搜索模式
        window.changeSearchMode = function(){
            $("#main").hide();
            $("#positionDiv").hide();
            $("#starDiv").hide();
            $("#notFoundDiv").hide();
            $("#searchDiv").show();
        };

        // 切换搜索模式
        window.changePositionMode = function(){
            $("#starDiv").hide();
            $("#main").hide();
            $("#notFoundDiv").hide();
            $("#searchDiv").hide();
            $("#positionDiv").show();
        };

        // 切换首页模式
        window.changeIndexMode = function(){
            $("#notFoundDiv").hide();
            $("#searchDiv").hide();
            $("#positionDiv").hide();
            $("#starDiv").show();
            $("#main").show();
        };


        // 搜索文本
        window.searchFavorites = function(name){
            changeSearchMode();
            layer.load();
            $.ajax({
                type: "GET",
                url: "favorites/search",
                data: {"name": name},
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    $("#searchDiv").empty();
                    if (result.code == 0 && (result.data.favoritesList.length > 0 || result.data.categoryList.length > 0)) {
                        var html = '';
                        html += '<ul class="favorites">';
                        $.each(result.data.categoryList, function (i, c) {
                            html += '<li class="favorites-li layui-anim layui-anim-fadein" data-id="' + c.id + '" onclick="showFavorites(this)">';
                            html += '   <div class="favorites-bg">';
                            html += '       <img src="images/category.svg"/>';
                            html += '   </div>';
                            html += '   <p class="myToolTip" title="' + c.name + '">' + c.name + '</p>';
                            html += '   <i onclick="editCategory(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                            html += '</li>';
                        });
                        $.each(result.data.favoritesList, function (i, f) {
                            html += '<li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" data-schema="' + f.schemaName + '" onclick="openUrl(this)">';
                            html += '   <div class="favorites-bg">';
                            html += '       <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                            html += '   </div>';
                            html += '   <p class="myToolTip" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</p>';
                            html += '   <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                            html += '</li>';
                        });
                        html += '</ul>';
                        var searchDiv = $("#searchDiv").append(html);
                        loadImg(searchDiv);
                        // 存入历史记录
                        var input_history = JSON.parse(localStorage.getItem("input_history"));
                        if (input_history == null || input_history.length >= 5) input_history = [];
                        if (input_history.indexOf(name) < 0) input_history.push(name);
                        localStorage.setItem("input_history", JSON.stringify(input_history));
                    }else{
                        $("#notFoundDiv").show();
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                }
            });
        };

        window.showFavorites = function(obj){
            layer.load();
            $.ajax({
                type: "GET",
                url: "category/favorites/" + $(obj).attr("data-id"),
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    $("#searchDiv").empty();
                    if (result.code == 0 && result.data.length > 0) {
                        var html = '';
                        html += '<ul class="favorites">';
                        $.each(result.data, function (i, f) {
                            html += '<li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" data-schema="' + f.schemaName + '" onclick="openUrl(this)">';
                            html += '   <div class="favorites-bg">';
                            html += '       <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                            html += '   </div>';
                            html += '   <p class="myToolTip" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</p>';
                            html += '   <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                            html += '</li>';
                        });
                        html += '</ul>';
                        var searchDiv = $("#searchDiv").append(html).show();
                        loadImg(searchDiv);
                        $("#notFoundDiv").hide();
                    }else{
                        $("#notFoundDiv").show();
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                }
            });
        };

        $(document).on("keydown", function(event){
            if(event.ctrlKey && event.key === "f"){
                $("#search_name").focus();
                // 阻止默认浏览器动作(W3C)
                var e = event;
                if ( e && e.preventDefault )
                    e.preventDefault();
                // IE中阻止函数器默认动作的方式
                else
                    window.event.returnValue = false;
                return false;
            }
        });

        // 搜索
        $("#search_name").on("keydown", function (event) {
            // 1.按上下键进入选择模式，并控制，返回键退出选择模式
            // 2.在选择模式时，按下回车跳转超链接，输入值，退出选择模式
            // 3.不在选择模式时，输入框有值，按下回车查询，输入框没有值，按下回车退出查询模式
            if (event.key === "Enter") {
                var hidden = $(".search-items").is(":hidden");
                var activeLi = $(".favorites-li.active:visible")[0];
                if(typeof activeLi !== "undefined" && hidden){
                    $(activeLi).click();
                }else{
                    var name = $(this).val().trim();
                    if (name == "") { //退出搜索模式
                        $("#search_close").click();
                    } else if(name.indexOf("打开") == 0 || name.indexOf("Open") == 0) { //搜索快捷指令
                        searchShortcut(name);
                    } else {// 搜索文本
                        searchFavorites(name);
                    }
                }
                if(!hidden){
                    $(".search-items").hide();
                }
            } else if (event.key === "ArrowDown") {
                // 判断搜索选项是否隐藏，如果隐藏，则进入选择模式
                var hidden = $(".search-items").is(":hidden");
                if(hidden){
                    var activeLi = $(".favorites-li.active:visible")[0];
                    var list = $(".favorites-li:visible");
                    if(typeof activeLi === "undefined"){
                        list.eq(0).addClass("active");
                    }else{
                        var nextActiveLi;
                        var last;
                        list.each(function(index,item){
                            if($(item).hasClass("active")){
                                var nextIndex = index + 1;
                                nextActiveLi = list[nextIndex];
                                if(nextIndex + 1 === list.length){
                                    last = true
                                }
                                return false;
                            }
                        });
                        if(typeof nextActiveLi !== "undefined"){
                            $(activeLi).removeClass("active");
                            $(nextActiveLi).addClass("active");
                            // 滚动
                            if(last){
                                $("#layuiBody").animate({scrollTop: $("#layuiBody")[0].scrollHeight}, 50);
                            }else{
                                elasticScroll(nextActiveLi.offsetTop);
                            }
                        }
                    }
                }else{
                    var hover_in = typeof $(".search-items li.hover-in")[0] === "undefined" ? $(".search-items li:first")[0] : $(
						".search-items li.hover-in").next()[0];
					if (typeof hover_in !== "undefined") {
						$(hover_in).addClass('hover-in').siblings().removeClass('hover-in');
						$(this).val(hover_in.innerText);
					}else{
					    $(".search-items").hide();
					}
                }
            } else if (event.key === "ArrowUp") {
                // 判断搜索选项是否隐藏，如果隐藏，则进入选择模式
                var hidden = $(".search-items").is(":hidden");
                if(hidden){
                    var activeLi = $(".favorites-li.active:visible")[0];
                    var list = $(".favorites-li:visible");
                    if(typeof activeLi === "undefined"){
                        list.eq(0).addClass("active");
                    }else{
                        var nextActiveLi;
                        var first;
                        list.each(function(index,item){
                            if($(item).hasClass("active")){
                                var nextIndex = index - 1;
                                nextActiveLi = list[nextIndex];
                                if(nextIndex === 0){
                                    first = true;
                                }
                                return false;
                            }
                        });
                        if(typeof nextActiveLi !== "undefined"){
                            $(activeLi).removeClass("active");
                            $(nextActiveLi).addClass("active");
                            // 滚动
                            if(first){
                                $("#layuiBody").animate({scrollTop: 0}, 50);
                            }else{
                                elasticScroll(nextActiveLi.offsetTop);
                            }
                        }
                    }
                }else{
                    var hover_in = typeof $(".search-items li.hover-in")[0] === "undefined" ? $(".search-items li:last")[0] : $(
						".search-items li.hover-in").prev()[0];
					if (typeof hover_in !== "undefined") {
						$(hover_in).addClass('hover-in').siblings().removeClass('hover-in');
						$(this).val(hover_in.innerText);
					}else{
					    $(".search-items").hide();
					}
                }
            } else if (event.key === "Backspace") {
                // 退出选择模式
                $(".favorites-li.active").removeClass("active");
            }
        }).on("input", function () {
            //退出选择模式
            $(".favorites-li.active").removeClass("active");
        }).on("focus", function () {
           $("#search_close").show();
            var html = '';
            var input_history = JSON.parse(localStorage.getItem("input_history"));
            $.each(input_history, function(index, item) {
                html = '<li>' + item + '<i class="layui-icon layui-icon-close history-close"></i></li>' + html;
            });
            if (html !== "") $(".search-items").empty().append(html).show();
        });
        // 添加收藏
        window.addFavorites = function (categoryId) {
            $("#addFavoritesBtn").click();
            form.val("add-favorites", {
                "categoryId": categoryId
            });
        }
        // 发送验证码
        window.sendEmailCode = function (obj) {
            var email = $("#newEmail").val();
            var reg = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            if(email.match(reg)){
                obj.setAttribute("disabled", true);
                obj.value="重试(60)";
                // 倒计时
                var countdown = 59;
                var interval = setInterval(function() {
                    if (countdown == 0) {
                        obj.removeAttribute("disabled");
                        obj.value="点击获取";
                        countdown = 59;
                        clearInterval(interval);
                    } else {
                        obj.setAttribute("disabled", true);
                        obj.value="重试(" + countdown + ")";
                        countdown--;
                    }
                }, 1000);
                // 请求后台
                $.ajax({
                    type: "GET",
                    url: "user/email/code",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    data: {"email": email}
                });
            }else{
                $("#newEmail").focus().addClass("layui-form-danger");
                layer.msg('邮箱格式不正确', {icon: 5, anim: 6});
            }
        };

        // 弹性滚动
        window.elasticScroll = function(height){
            var visibleHeight = $("#layuiBody").height();
            var shouldScroll = Math.floor(height/ visibleHeight) * visibleHeight;
            var scrollTop = $("#layuiBody").scrollTop();
            if(Math.abs(scrollTop - shouldScroll) >= visibleHeight){
                $("#layuiBody").animate({scrollTop: shouldScroll}, 50);
            }
        };

        window.isEmpty = function(obj){
            if(typeof obj == "undefined" || obj == "undefined" || obj == null || obj == "" || obj == "none" || obj == "null"){
                return true;
            }else{
                return false;
            }
        };

        // 打开新窗口
        window.openUrl = function (obj, onlyOpen) {
            var url = $(obj).attr("data-url");
            var schema = $(obj).attr("data-schema");
            if(url.indexOf("https://") == 0 || url.indexOf("http://") == 0){
                if(!isEmpty(schema)&&isMobile()){
                    layer.confirm('是否打开app？', {
                      btn: ['确认', '取消']
                    }, function(index, layero){
                        url = schema + url.substring(url.indexOf("://"));
                        newWin(url);
                        layer.close(index);
                    }, function(index){
                        newWin(url);
                        layer.close(index);
                    });
                }else{
                    newWin(url);
                }
                // 记录访问时间
                if(!onlyOpen){
                    $.ajax({
                        type: "GET",
                        url: "favorites/visit/" + $(obj).attr("data-id"),
                        headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")}
                    });
                }
            }else{
                layer.msg('此链接无效', {icon: 7});
            }
        };

        window.newWin = function(url) {
          var a = document.createElement('a');
          a.setAttribute('href', url);
          a.setAttribute('target', '_blank');
          document.body.appendChild(a);
          a.click();
          a.remove();
        };

        // 编辑分类
        window.editCategory = function (obj, e) {
            window.event ? window.event.cancelBubble = true : e.stopPropagation();//阻止冒泡
            var index = layer.open({
                type: 1,
                title: "修改分类",
                area: '400px',
                content: $('#update-category')
            });
            indexMap.set('#update-category',index);
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "category/" + $(obj).parent().attr("data-id"),
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-category", {
                            "id": data.id
                            , "name": data.name
                            , "sort": data.sort
                            , "bookmark": data.bookmark
                        });
                        //禁用系统分类
                        if (data.isSystem == 1) {
                            $("#categoryName").attr("disabled", true);
                            $("#categorySort").attr("disabled", true);
                        } else {
                            $("#categoryName").removeAttr("disabled");
                            $("#categorySort").removeAttr("disabled");
                        }
                    }
                }
            });
        };

        // 新增分类
        $("#addCategoryBtn").click(function () {
            layer.prompt({title: "添加分类", placeholder:"输入分类名称", maxlength: 20}, function (value, index, elem) {
                // 验证
                var bool = true;
                $.ajax({
                    type: "GET",
                    url: 'category/check/' + value,
                    async: false,
                    dataType: 'json',
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        if (result.code == 0) {
                            layer.tips('分类已存在', elem, {tips: 3});
                            bool = false;
                        }
                    }
                });
                if(bool){
                    layer.close(index);
                    layer.load();
                    $.ajax({
                        type: "POST",
                        url: "category",
                        data: JSON.stringify({"name": value}),
                        contentType: 'application/json;charset=utf-8',
                        dataType: "json",
                        headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                        success: function (result) {
                            layer.closeAll('loading');
                            if (result.code == 0) {
                                window.location.reload();
                            } else {
                                layer.msg(result.msg, {icon: 5});
                            }
                        }
                    });
                }
            });
        });

        // 新增分类
        $("#addCategoryIcon").click(function () {
            layer.prompt({title: "添加分类", placeholder:"输入分类名称", maxlength: 20}, function (value, index, elem) {
                // 验证
                var bool = true;
                $.ajax({
                    type: "GET",
                    url: 'category/check/' + value,
                    async: false,
                    dataType: 'json',
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        if (result.code == 0) {
                            layer.tips('分类已存在', elem, {tips: 3});
                            bool = false;
                        }
                    }
                });
                if(bool){
                    layer.close(index);
                    layer.load();
                    $.ajax({
                        type: "POST",
                        url: "category",
                        data: JSON.stringify({"name": value}),
                        contentType: 'application/json;charset=utf-8',
                        dataType: "json",
                        headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                        success: function (result) {
                            layer.closeAll('loading');
                            if (result.code == 0) {
                                loadCategoryList(result.data.id);
                            } else {
                                layer.msg(result.msg, {icon: 5});
                            }
                        }
                    });
                }
            });
        });

        window.exportNow = function(){
            $("#export").click();
            layer.closeAll();
        };

        // 清除数据
        $("#cleanData").click(function(){
            var aHtml = '<a class="layui-blue" href="javascript:exportNow();">立即备份</a>';
            layer.confirm('该操作会清除您在平台上的所有数据，且不可恢复，清除数据前应做好备份('+ aHtml +')，谨慎操作！确认清除所有数据吗？', {title:'清除数据'}, function(index){
                layer.close(index);

                layer.prompt({formType: 1, title: "登录密码", placeholder:"请输入登录密码", maxlength: 20}, function(value, index, elem){
                    $.ajax({
                        type: "POST",
                        url: "user/cleanData",
                        data: {"loginPwd":md5(value)},
                        dataType: "json",
                        headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                        success: function (result) {
                            if (result.code == 0) {
                                window.location.reload();
                            } else {
                                layer.msg(result.msg, {icon: 5});
                            }
                        }
                    });
                  layer.close(index);
                });
            });
        });

        // 修改密码
        $("#changePwd").click(function () {
            var index = layer.open({
                type: 1,
                title: "修改密码",
                area: '400px',
                content: $('#passwordForm')
            });
            indexMap.set('#changePwd',index);
            // 表单赋值
            form.val("passwordForm", {
                "oldPassword": ""
                , "newPassword": ""
                , "confirmPassword": ""
            });
        });

        // 修改邮箱
        $("#changeEmail").click(function () {
            var index = layer.open({
                type: 1,
                title: "修改邮箱",
                area: '400px',
                content: $('#emailForm')
            });
            indexMap.set('#changeEmail',index);
            // 表单赋值
            form.val("emailForm", {
                "newEmail": ""
                , "code": ""
            });
        });

        // 登出
        $("#logout").click(function () {
            layer.confirm('确认退出系统吗？', function(index){
                layer.close(index);

                localStorage.clear();
                window.location.href = "login.html";
            });
        });

        // 加载分类
        window.loadCategoryList = function (id) {
            $.ajax({
                type: "GET",
                url: "category/list",
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        var oHtml = '';
                        var lHtml = '';
                        $.each(result.data, function (i, c) {
                            c.page = parseInt(i / indexPageSize) + 1;
                            oHtml += '<option value="' + c.id + '" ' + ((c.id == id||i == 0) ? 'selected' : '') +'>' + c.name + '</option>';
                            lHtml += '<li onclick="position(' + c.id + ')">' + c.name + '</li>';
                        });
                        $("select[name='categoryId']").empty().append(oHtml);
                        $("#catalogList").empty().append(lHtml);

                        form.render('select','update-favorites');
                        form.render('select','add-favorites');
                    }
                }
            });
        };

        window.loadStarFavorites = function () {
            $.ajax({
                type: "GET",
                url: "favorites/star",
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    $("#starDiv").empty();
                    if(result.code == 0 && result.data.length > 0){
                        var html = '';
                        html += '<div class="category">';
                        html += '   <div class="title" style="font-size:16px;">常用网址</div>';
                        html += '   <ul class="favorites">';
                        $.each(result.data, function (i, f) {
                            html += '   <li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" data-schema="' + f.schemaName + '" onclick="openUrl(this)">';
                            html += '       <div class="favorites-bg">';
                            html += '           <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                            html += '       </div>';
                            html += '       <p class="myToolTip" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</p>';
                            html += '       <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                            html += '   </li>';
                        });
                        html += '   </ul>';
                        html += '</div>';

                        var startDiv = $("#starDiv").append(html);
                        loadImg(startDiv);
                    }
                }
            });
        };

        // 显示更多
        window.moreFavorites = function (categoryId) {
            layer.load();
            $.ajax({
                type: "GET",
                url: "favorites/more",
                data: {"categoryId": categoryId},
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        var html = '';
                        $.each(result.data, function (i, f) {
                            html += '<li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" data-schema="' + f.schemaName + '" onclick="openUrl(this)">';
                            html += '   <div class="favorites-bg">';
                            html += '       <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                            html += '   </div>';
                            html += '   <p class="myToolTip" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</p>';
                            html += '   <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                            html += '</li>';
                        });
                        var favoritesDiv = $("div[data-id='" + categoryId + "']").find(".favorites").empty().append(html);
                        loadImg(favoritesDiv);
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                }
            });
        };

        // 删除收藏
        $("#deleteFavorites").click(function () {
            layer.confirm('确认删除收藏吗?', function(index){
                layer.close(index);
                layer.load();
                var data = form.val("update-favorites");
                $.ajax({
                    type: "GET",
                    url: "favorites/delete/" + data.id,
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        layer.closeAll('loading');
                        layer.close(indexMap.get('#update-favorites'));
                        if (result.code == 0) {
                            window.location.reload();
                        } else {
                            layer.msg(result.msg, {icon: 5});
                        }
                    }
                });
            });
        });

        // 删除快捷导航
        window.deleteFastNav = function(obj, e){
            window.event ? window.event.cancelBubble = true : e.stopPropagation();//阻止冒泡
            layer.confirm('确认删除快捷导航吗?', function(index){
                layer.close(index);
                layer.load();
                $.ajax({
                    type: "GET",
                    url: "quick-navigation/delete/" + $(obj).parent().attr("data-id"),
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        layer.closeAll('loading');
                        if (result.code == 0) {
                            $(obj).parent().remove();
                            $("#addFastNavBtn").show();
                        } else {
                            layer.msg(result.msg, {icon: 5});
                        }
                    }
                });
            });
        };

        // 清空收藏
        $("#clean").click(function () {
            layer.confirm('确认清空分类下所有收藏吗?', function(index){
                layer.close(index);
                layer.load();
                var data = form.val("update-category");
                $.ajax({
                    type: "POST",
                    url: "category/clean",
                    data: {"id": data.id},
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        layer.closeAll('loading');
                        layer.close(indexMap.get('#update-category'));
                        if (result.code == 0) {
                            window.location.reload();
                        } else {
                            layer.msg(result.msg, {icon: 2});
                        }
                    }
                });
            });
        });

        // 删除分类
        $("#deleteCategory").click(function () {
            layer.confirm('确认删除分类吗?', function(index){
                layer.close(index);
                layer.load();
                var data = form.val("update-category");
                $.ajax({
                    type: "GET",
                    url: "category/delete/" + data.id,
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        layer.closeAll('loading');
                        layer.close(indexMap.get('#update-category'));
                        if (result.code == 0) {
                            window.location.reload();
                        } else {
                            layer.msg(result.msg, {icon: 2});
                        }
                    }
                });
            });
        });

        // 编辑收藏
        window.editFavorites = function (obj, e) {
            window.event ? window.event.cancelBubble = true : e.stopPropagation();//阻止冒泡
            var index = layer.open({
                type: 1,
                title: "修改收藏",
                skin: 'to-fix-select',
                area: '400px',
                content: $('#update-favorites')
            });
            indexMap.set('#update-favorites',index);
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "favorites/" + $(obj).parent().attr("data-id"),
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-favorites", {
                            "id": data.id
                            , "categoryId": data.categoryId
                            , "name": data.name
                            , "url": data.url
                            , "sort": data.sort
                            , "star": data.star
                            , "isShare": data.isShare
                            , "shortcut": data.shortcut
                            , "schemaName": data.schemaName
                        });
                    }
                }
            });
        };

        form.verify({
            confirmPassword: function (value, item) {
                if($("#newPassword").val() !== value){
                    return "两次输入密码不一致";
                }
            },
            sortNum: function (value, item) {
                if(value != ""){
                    if(isNaN(value)){
                        return "请输入0~9999之间的整数";
                    }else if(value%1 !== 0){
                        return "请输入0~9999之间的整数";
                    }else if(value > 9999){
                        return "请输入0~9999之间的整数";
                    }
                }
            },
            exitEmail: function (value, item) {
                var msg;
                $.ajax({
                    type: "GET",
                    url: 'register/email/' + value,
                    async: false,
                    dataType: 'json',
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        if (result.code != 0) {
                            msg = "邮箱已存在";
                        }
                    }
                });
                return msg;
            },
            shortcut: function (value, item) {
                if(value !== ""){
                    if(!value.indexOf("打开") == 0 && !value.indexOf("Open") == 0){
                        return '指令请以"打开"或"Open"开头';
                    }
                    var msg;
                    $.ajax({
                        type: "GET",
                        url: 'favorites/shortcut?key=' + value,
                        async: false,
                        dataType: 'json',
                        headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                        success: function (result) {
                            if (result.code == 0 && result.data.id != $("#favoritesId").val()) {
                                msg = "指令已存在";
                            }
                        }
                    });
                    return msg;
                }
            },
            category: function (value, item) {
                var categoryId = form.val("update-category").id;
                var msg;
                $.ajax({
                    type: "GET",
                    url: 'category/check/' + value,
                    async: false,
                    dataType: 'json',
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        if (result.code == 0 && result.data.id != categoryId) {
                            msg = "分类已存在";
                        }
                    }
                });
                return msg;
            }
        });

        form.on('switch(viewStyle)', function(data){
            if(data.elem.checked){
                $("#layuiBody").addClass("bookmark");
            }else{
                $("#layuiBody").removeClass("bookmark");
            }
            $.ajax({
                type: "POST",
                url: "user/style",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                data: {"viewStyle": data.elem.checked? 1 : 0}
            });
        });

        form.on('switch(starSwitch)', function(data){
            layer.load();
            $.ajax({
                type: "POST",
                url: "favorites/star",
                data: JSON.stringify({"id": $("#favoritesId").val(),"star": data.elem.checked? 1 : 0}),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        layer.msg("操作成功", {icon: 6});
                        loadStarFavorites();
                        // 退出搜索模式
                        $("#search_close").click();
                    } else {
                        layer.msg(result.msg, {icon: 5});
                        // 回退
                        $(data.elem).removeAttr("checked");
                        $(data.othis).removeClass("layui-form-onswitch");
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                    // 回退
                    $(data.elem).removeAttr("checked");
                    $(data.othis).removeClass("layui-form-onswitch");
                }
            });
        });

        form.on('switch(shareSwitch)', function(data){
            layer.load();
            $.ajax({
                type: "POST",
                url: "favorites/share",
                data: JSON.stringify({"id": $("#favoritesId").val(),"isShare": data.elem.checked? 1 : 0}),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        layer.msg("操作成功", {icon: 6});
                    } else {
                        layer.msg(result.msg, {icon: 5});
                        // 回退
                        $(data.elem).removeAttr("checked");
                        $(data.othis).removeClass("layui-form-onswitch");
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                    // 回退
                    $(data.elem).removeAttr("checked");
                    $(data.othis).removeClass("layui-form-onswitch");
                }
            });
        });

        form.on('switch(bookmarkSwitch)', function(data){
            var categoryId = form.val("update-category").id;
            layer.load();
            $.ajax({
                type: "POST",
                url: "category/bookmark",
                data: JSON.stringify({"id": categoryId,"bookmark": data.elem.checked? 1 : 0}),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        layer.msg("操作成功", {icon: 6});
                        if(data.elem.checked){
                             $("div[data-id=" + categoryId + "]").addClass("bookmark");
                        }else{
                             $("div[data-id=" + categoryId + "]").removeClass("bookmark");
                        }
                    } else {
                        layer.msg(result.msg, {icon: 5});
                        // 回退
                        $(data.elem).removeAttr("checked");
                        $(data.othis).removeClass("layui-form-onswitch");
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg('服务器异常', {icon: 2});
                    // 回退
                    $(data.elem).removeAttr("checked");
                    $(data.othis).removeClass("layui-form-onswitch");
                }
            });
        });

        // 新增收藏
        form.on('submit(addFavorites)', function (data) {
            layer.load();
            $.ajax({
                type: "POST",
                url: "favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    layer.close(indexMap.get('#add-favorites'));
                    if (result.code == 0) {
                        window.location.reload();
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        // 新增快捷导航
        form.on('submit(addFastNav)', function (data) {
            layer.load();
            $.ajax({
                type: "POST",
                url: "quick-navigation",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    layer.close(indexMap.get('#add-favorites'));
                    if (result.code == 0) {
                        window.location.reload();
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        // 保存密码
        form.on('submit(savePwd)', function (data) {
            if(!data.field.account && !data.field.password){
                return false;
            }
            layer.load();
            $.ajax({
                type: "POST",
                url: "password",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        //给表单赋值
                        form.val("setting-pwd", {
                            "id": result.data
                        });
                        layer.msg("保存成功", {icon: 6});
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改邮箱
        form.on('submit(updateEmail)', function (data) {
            layer.load();
            $.ajax({
                type: "POST",
                url: "user/email",
                data: data.field,
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    layer.close(indexMap.get('#editEmail'));
                    if (result.code == 0) {
                        layer.msg("修改成功", {icon: 6});
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改收藏
        form.on('submit(updateFavorites)', function (data) {
            layer.load();
            $.ajax({
                type: "POST",
                url: "favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    layer.close(indexMap.get('#update-favorites'));
                    if (result.code == 0) {
                        window.location.reload();
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改分类
        form.on('submit(updateCategory)', function (data) {
            layer.load();
            $.ajax({
                type: "POST",
                url: "category",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    layer.close(indexMap.get('#update-category'));
                    if (result.code == 0) {
                        window.location.reload();
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        // 修改密码
        form.on('submit(updatePassword)', function (data) {
            layer.load();
            $.ajax({
                type: "POST",
                url: "user/password",
                data: {"oldPassword":md5(data.field.oldPassword),"newPassword":md5(data.field.newPassword)},
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    layer.close(indexMap.get('#changePwd'));
                    if (result.code == 0) {
                        layer.msg('修改成功', {icon: 6, time: 1000}, function(){
                            localStorage.clear();
                            window.location.href = "login.html";
                        });
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        // 搜索项绑定hover事件
        $(document).on('mouseenter', '.search-items li', function() {
            $(this).addClass('hover-in');
        });

        $(document).on('mouseleave', '.search-items li', function() {
            $(this).removeClass('hover-in');
        });

        window.position = function(id){
            changePositionMode();
            layer.close(indexMap.get('#catalog'));
            layer.load();
            $.ajax({
                type: "GET",
                url: "favorites/position/" + id,
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    layer.closeAll('loading');
                    if (result.code == 0) {
                        // 加载数据
                        var c = result.data;
                        var html = '';
                        var bookmarkClass = c.bookmark==1?"bookmark":"";
                        html += '<div class="category ' + bookmarkClass + '" data-id="' + c.id + '">';
                        html += '   <div class="title" onclick="editCategory(this,event)">' + c.name + '</div>';
                        html += '   <ul class="favorites">';
                        if(c.favorites.length > 0) {
                            $.each(c.favorites, function (j, f) {
                                html += '   <li class="favorites-li layui-anim layui-anim-fadein" data-id="' + f.id + '" data-url="' + f.url + '" data-schema="' + f.schemaName + '" onclick="openUrl(this)">';
                                html += '       <div class="favorites-bg">';
                                html += '           <img src="images/book.svg" lay-src="' + f.icon + '"/>';
                                html += '       </div>';
                                html += '       <p class="myToolTip" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</p>';
                                html += '       <i onclick="editFavorites(this,event)" class="action-icon layui-icon layui-icon-more-vertical"></i>';
                                html += '   </li>';
                                if(j == favoritesLimit - 1){
                                    html += '<li class="layui-anim layui-anim-fadein" onclick="moreFavorites(' + c.id + ')">';
                                    html += '   <div class="favorites-bg">';
                                    html += '       <img src="images/more.svg"/>';
                                    html += '   </div>';
                                    html += '   <p title="显示更多">显示更多</p>';
                                    html += '</li>';
                                    return false;
                                }
                            });
                        } else {
                            html += '<li class="layui-anim layui-anim-fadein" onclick="addFavorites(' + c.id + ')">';
                            html += '   <div class="favorites-bg">';
                            html += '       <img src="images/add.svg"/>';
                            html += '   </div>';
                            html += '   <p title="添加网址">添加网址</p>';
                            html += '</li>';
                        }
                        html += '   </ul>';
                        html += '</div>';
                        var positionData = $("#positionData").empty().append(html);
                        loadImg(positionData);
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                    layer.msg("服务器异常", {icon: 2});
                }
            });
        };

        window.loadUserInfo = function(){
            $.ajax({
                type: "GET",
                url: "user/info",
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        var user = result.data;
                        $("#username").text(user.username.substring(0, 4));
                        form.val("styleSelect", {"viewStyle": user.viewStyle});
                        if(user.viewStyle == 1)$("#layuiBody").addClass("bookmark");
                    }
                }
            });
        };

        window.loadUserData = function(){
            $.ajax({
                type: "GET",
                url: "user/data",
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        var user = result.data;
                        $("#favorites").attr("title","收藏("+ user.favorites +")");
                        $("#moment").attr("title","瞬间("+ user.moments +")");
                        $("#task").attr("title","日程("+ user.tasks +")");
                        $("#search").attr("title","搜索("+ user.searchTypes +")");
                        $("#navigation").attr("title","导航("+ user.navigations +")");
                        $("#memorandum").attr("title","备忘录("+ user.memorandums +")");
                        form.render('checkbox','userData');
                    }
                }
            });
        };

        window.initClipboard = function(){
            var clipboard = new ClipboardJS('#accountCopy');
            clipboard.on('success', function(e) {layer.msg("复制成功");});
            clipboard.on('error', function(e) {layer.msg("复制失败");});

            var clipboard1 = new ClipboardJS('#passwordCopy');
            clipboard1.on('success', function(e) {layer.msg("复制成功");});
            clipboard1.on('error', function(e) {layer.msg("复制失败");});

            var clipboard2 = new ClipboardJS('#edit_url_input_copy');
            clipboard2.on('success', function(e) {layer.msg("复制成功");});
            clipboard2.on('error', function(e) {layer.msg("复制失败");});
        };

        $("#slideBtn").click(function(){
            var width = parseInt($(window).width()) * 0.9;
            width = (width >= 500 ? 500 : (width <= 340 ? 340 : width)) + 'px';
            var index = layer.open({
                type: 1,
                title: "目录",
                area: [width, '300px'],
                content: $("#catalog")
            });
            indexMap.set('#catalog',index);
        });

        // 回收站
        $("#recycle").click(function() {
            var width = parseInt($(window).width()) * 0.9;
            width = (width >= 800? 800 : width) + 'px';
            var index = layer.open({
                type: 2,
                area: [width,'530px'],
                title: false,
                closeBtn: 0,
                content: 'recycle.html'
            });
            indexMap.set('#importOrExport',index);
        });

        window.initTitle = function(){
            var x = 10;
            var y = 20;
            var newTitle = '';
            $(document).on('mouseover','p.myToolTip',function (e) {
                newTitle = this.title;
                this.title = '';
                $('body').append('<div id="myTitle" >' + newTitle + '</div>');
                $('#myTitle').css({
                    'left': (e.pageX + x + 'px'),
                    'top': (e.pageY + y + 'px'),
                    'z-index': 2147483647
                }).show();
            });
            $(document).on('mouseout','p.myToolTip',function () {
                this.title = newTitle;
                $('#myTitle').remove();
            });
            $(document).on('mousemove','p.myToolTip',function (e) {
                $('#myTitle').css({
                    'left': (e.pageX + x + 10 + 'px'),
                    'top': (e.pageY + y - 20 + 'px'),
                    'z-index': 2147483647
                }).show();
            });
        };

        window.escapeHtml = function(html){
            return html.replace(/</g, '&lt').replace(/>/g, '&gt');
        };

        window.showNotice = function(type){
            // 查询公告
            $.ajax({
                type: "GET",
                url: "user/notice",
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    var data = result.data;
                    if (data.isShow) {
                        // 显示按钮
                        if(parseInt($(window).width()) >= 550){
                            $("#notice cite").text(data.title);
                            $("#notice").show();
                        }
                        if(type == "ready" && localStorage.getItem("notShowNotice")){
                            return false;
                        }
                        // 弹出公告
                        var width = parseInt($(window).width()) * 0.9;
                        width = (width >= 970 ? 970 : width) + 'px';
                        var index = layer.open({
                            title: '公告'
                            ,content: data.content
                            ,area: [width, '400px']
                            ,btn: ['知道了']
                            ,yes: function(index, layero){
                                layer.close(index);
                                localStorage.setItem("notShowNotice", true);
                            }
                        });
                        indexMap.set('#showNotice',index);
                    }else{
                        if(type == "click"){
                            layer.alert('暂无公告！', {icon: 0});
                        }else{
                            $("#notice").hide();
                        }
                    }
                }
            });
        };

        $(".layui-icon-tips").hover(function(){
            var that = $(this);
            layer.tips(that.attr("lay-title"), that, {tips: 3});
        },function(){
            layer.closeAll('tips');
        });

        // 页面加载完成执行
        $(function () {
            // 加载用户信息
            loadUserInfo();
            // 加载常用网址
            loadStarFavorites();
            // 加载分类
            loadCategoryList();
            // 初始化剪贴板插件
            initClipboard();
            // 加载用户数据
            loadUserData();
            // 初始化title
            initTitle();
            // 显示公告
            showNotice('ready');
        });
    });
</script>
</body>
</html>