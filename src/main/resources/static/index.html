<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>网络收藏夹|首页</title>
    <link rel="stylesheet" href="/layui/css/layui.css">
    <style>
        legend {
            cursor: pointer;
        }

        .add-icon {
            color: #666;
            font-size: 30px;
        }

        .favorites {
            overflow: hidden;
            padding: 10px;
        }

        .favorites li {
            position: relative;
            float: left;
            padding: 10px 20px;
            cursor: pointer;
        }

        .favorites li .favorites-bg {
            width: 80px;
            height: 80px;
            line-height: 80px;
            text-align: center;
            border-radius: 50%;
            background-color: #f1f3f4;
        }

        .favorites li .favorites-bg img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .favorites li:hover {
            background-color: #f2f2f2;
        }

        .favorites li:hover .favorites-bg {
            background-color: #e5e7e8;
        }

        .favorites li p {
            text-align: center;
            margin-top: 10px
        }

        .favorites li .action-icon {
            position: absolute;
            top: 4px;
            right: 0;
            font-size: 20px;
            font-weight: bold;
            color: #666;
            display: none;
        }

        .favorites li:hover .action-icon {
            display: block;
        }
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo">网络收藏夹</div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                    <span id="username">默认用户</span>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:;" onclick="changePwd()">修改密码</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a href="javascript:;" onclick="logout()">安全退出</a></li>
        </ul>
    </div>

    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree" lay-filter="test">
                <li class="layui-nav-item"><a href=""><i class="layui-icon layui-icon-website"
                                                         style="margin-right: 10px"></i>我的收藏夹</a></li>
            </ul>
        </div>
    </div>

    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div style="padding: 15px;" id="main">
            <div class="layui-btn-container">
                <button type="button" class="layui-btn" onclick="addCategory(this)">添加分类</button>
            </div>
        </div>
    </div>
</div>
<!-- 添加收藏表单 -->
<form class="layui-form" action="" id="add-favorites" lay-filter="add-favorites" style="display: none;padding: 10px">
    <input type="hidden" name="categoryId">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-block">
            <input type="text" name="name" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-block">
            <input type="text" name="url" required lay-verify="required" placeholder="请输入地址" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="addFavorites">立即提交</button>
        </div>
    </div>
</form>
<!-- 编辑收藏表单 -->
<form class="layui-form" action="" id="update-favorites" lay-filter="update-favorites"
      style="display: none;padding: 10px">
    <input type="hidden" name="id">
    <input type="hidden" name="categoryId">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-block">
            <input type="text" name="name" required lay-verify="required" placeholder="请输入标题" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-block">
            <input type="text" name="url" required lay-verify="required" placeholder="请输入标题" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updateFavorites">立即提交</button>
            <button type="button" class="layui-btn layui-btn-danger" id="deleteFavorites">删除</button>
        </div>
    </div>
</form>
<!-- 修改密码表单 -->
<form class="layui-form" action="" id="password" style="display: none;padding: 10px">
    <div class="layui-form-item">
        <label class="layui-form-label">旧密码</label>
        <div class="layui-input-inline">
            <input type="password" name="oldPassword" required lay-verify="required" placeholder="请输入密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新密码</label>
        <div class="layui-input-inline">
            <input type="password" name="newPassword" required lay-verify="required" placeholder="请输入密码"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updatePassword">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
<!-- 编辑分类表单 -->
<form class="layui-form" action="" id="update-category" lay-filter="update-category"
      style="display: none;padding: 10px">
    <input type="hidden" name="id">
    <div class="layui-form-item">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-block">
            <input type="text" name="name" required lay-verify="required" placeholder="请输入名称" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="updateCategory">立即提交</button>
            <button type="button" class="layui-btn layui-btn-danger" id="deleteCategory">删除</button>
        </div>
    </div>
</form>
<script src="/layui/layui.js"></script>
<script>
    //JavaScript代码区域
    layui.use(['element', 'jquery', 'layer', 'form'], function () {
        var element = layui.element;
        var $ = layui.$;
        var layer = layui.layer;
        var form = layui.form;

        // 编辑分类
        window.editCategory = function (obj) {
            layer.open({
                type: 1,
                title: "修改分类",
                content: $('#update-category') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "/category/" + $(obj).parent().attr("data-id"),
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-category", { //formTest 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
                            "id": data.id // "name": "value"
                            , "name": data.name
                        });
                    }
                }
            });
        };
        // 新增分类
        window.addCategory = function (obj) {
            layer.prompt({"title": "添加分类"}, function (value, index, elem) {
                $.ajax({
                    type: "POST",
                    url: "/category",
                    data: JSON.stringify({"name": value}),
                    contentType: 'application/json;charset=utf-8',
                    dataType: "json",
                    success: function (result) {
                        if (result.code == 0) {
                            // 新增分类
                            loadList();
                        }
                    }
                });
                layer.close(index);
            });
        };
        // 修改密码
        window.changePwd = function () {
            layer.open({
                type: 1,
                title: "修改密码",
                content: $('#password') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
        };
        // 登出
        window.logout = function () {
            $.ajax({
                type: "GET",
                url: "/user/logout",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        window.location.href = "/login.html";
                    }
                }
            });
        };
        // 加载数据
        window.loadList = function () {
            $.ajax({
                type: "GET",
                url: "/favorites/list",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        // 加载数据
                        var html = '';
                        $.each(result.data, function (i, c) {
                            html += '<fieldset class="layui-elem-field" data-id="' + c.id + '">';
                            html += '   <legend onclick="editCategory(this)">' + c.name + '</legend>';
                            html += '       <ul class="favorites">';
                            $.each(c.favorites, function (i, f) {
                                html += '           <li class="layui-anim layui-anim-scale">';
                                html += '               <a href="' + f.url + '" target="_blank">';
                                html += '                   <div class="favorites-bg">';
                                html += '                       <img src="' + f.icon + '" alt="' + f.name + '">';
                                html += '                   </div>';
                                html += '                   <p>' + f.name + '</p>';
                                html += '                   <i class="action-icon layui-icon layui-icon-more-vertical" data-id="' + f.id + '"></i>';
                                html += '               </a>';
                                html += '           </li>';
                            });
                            html += '           <li class="layui-anim layui-anim-scale" onclick="addFavorites(' + c.id + ')">';
                            html += '               <div class="favorites-bg"><i class="add-icon layui-icon layui-icon-add-1"></i></div>';
                            html += '               <p>添加地址</p>';
                            html += '           </li>';
                            html += '       </ul>';
                            html += '</fieldset>';
                        });
                        // 移除子元素
                        $("#main").children().filter("fieldset").remove();
                        $("#main").prepend(html)
                    }
                }
            });
        };

        // 阻止冒泡事件和默认事件
        window.stopBubbleAndDefault = function (e) {
            // 阻止冒泡
            if (e && e.stopPropagation)
                e.stopPropagation();
            else
                window.event.cancelBubble = true;
            // 阻止默认事件
            if (e && e.preventDefault)
                e.preventDefault();
            else
                window.event.returnValue = false;
            return false;
        };
        // 添加收藏
        window.addFavorites = function (categoryId) {
            layer.open({
                type: 1,
                title: "添加",
                content: $('#add-favorites') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
            // 表单赋值
            form.val("add-favorites", { //formTest 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
                "categoryId": categoryId // "name": "value"
            });
        };
        // 删除收藏
        $(document).on('click', '#deleteFavorites', function () {
            var data = form.val("update-favorites");
            $.ajax({
                type: "GET",
                url: "/favorites/delete/" + data.id,
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
        });
        // 删除分类
        $(document).on('click', '#deleteCategory', function () {
            var data = form.val("update-category");
            $.ajax({
                type: "GET",
                url: "/category/delete/" + data.id,
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        // 删除分类
                        $("fieldset[data-id='" + data.id + "']").remove();
                    }
                }
            });
        });
        // 编辑收藏
        $(document).on('click', '.action-icon', function (e) {
            layer.open({
                type: 1,
                title: "修改",
                content: $('#update-favorites') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
            });
            // 表单赋值
            $.ajax({
                type: "GET",
                url: "/favorites/" + $(this).attr("data-id"),
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let data = result.data;
                        //给表单赋值
                        form.val("update-favorites", { //formTest 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
                            "id": data.id // "name": "value"
                            , "categoryId": data.categoryId
                            , "name": data.name
                            , "url": data.url
                        });
                    }
                }
            });
            stopBubbleAndDefault(e);
        });

        //监听提交
        form.on('submit(addFavorites)', function (data) {
            $.ajax({
                type: "POST",
                url: "/favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
            return false;
        });
        //监听提交
        form.on('submit(updateFavorites)', function (data) {
            $.ajax({
                type: "POST",
                url: "/favorites/save",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
            return false;
        });
        //监听提交
        form.on('submit(updateCategory)', function (data) {
            $.ajax({
                type: "POST",
                url: "/category",
                data: JSON.stringify(data.field),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        loadList();
                    }
                }
            });
            return false;
        });
        //监听提交
        form.on('submit(updatePassword)', function (data) {
            $.ajax({
                type: "POST",
                url: "/user/password",
                data: data.field,
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        layer.closeAll();
                        layer.msg('修改成功', {icon: 6});
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
            return false;
        });

        $(function () {
            // 加载数据
            loadList();
            // 加载用户信息
            $.ajax({
                type: "GET",
                url: "/user/info",
                dataType: "json",
                success: function (result) {
                    if (result.code == 0) {
                        let username = result.data.username;
                        $("#username").text(username.substring(0, 8));
                    }
                }
            });
        });
    });
</script>
</body>
</html>