<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>网络收藏夹|备忘录</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="layui/css/layui.css">
    <style type="text/css">

            .layui-fixbar li:nth-child(2){
                font-size: 24px !important;
            }

			.home-icon {
				width: 30px;
				height: 30px;
				margin-top: 16px;
				margin-left: 20px;
				cursor: pointer;
			}

			.header {
			    position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 60px;
                background-color: #0A0E11;
			}

			.center {
			    position: fixed;
                width: 100%;
                top: 60px;
                bottom: 44px;
                overflow: auto;
			}

			.footer {
			    position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                height: 44px;
                line-height: 44px;
                background-color: #f5f7fa;
			}

			#logout {
                margin-top: 20px;
                margin-right: 20px;
                float: right;
			}

			.main {
                padding: 15px 10px;
			}

            .notFoundDiv {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .notFoundDiv img {
                width: 60px;
                display: block;
                margin: 0 auto;
            }

            .notFoundDiv span{
                display: block;
                text-align: center;
                font-size: 20px;
                color: #009688;
                margin-top: 24px;
                font-weight: bold;
            }

            .memorandum-list {
                padding: 0 10px;
            }

			.memorandum-item .memorandum-content {
			    word-wrap: break-word;
                padding-bottom:10px;
                line-height: 1.5;
                font-size: 14px;
                color: #393939;
			}

			.search-input {
                z-index: 999;
                position: absolute;
                top: 16px;
                right: 70px;
                width: 220px;
                height: 30px;
                transition: width .3s ease;
            }

            .search-input input {
                height: 100%;
                font-size: 12px;
                border: none;
                background-color: #161a1d;
                color: #b2b2b2;
                padding-left: 26px;
                padding-right: 26px;
            }

            .search-input .search-close {
                position: absolute;
                top: 4px;
                right: 4px;
                font-size: 20px;
                color: #666;
                display: none;
                cursor: pointer;
            }

            .search-input .search-icon {
                position: absolute;
                top: 8px;
                left: 6px;
                font-size: 14px;
                color: #999;
                cursor: pointer;
            }

            .highLight {
                background-color: rgba(255, 170, 0, 0.34);
                border: 1px solid #ffaa00;
            }

            .highLight.active {
                background-color: #c2cff9;
            }

            #search_info {
                position: absolute;
                top: 5px;
                right: 28px;
                color: #b2b2b2;
                cursor: pointer;
                display: none;
            }

            .layui-btn-del {
                position: absolute;
                bottom: 12px;
                right: 162px;
                height: 30px;
                line-height: 30px;
                padding: 0 15px;
            }
    </style>
</head>
<body>
<div class="header">
    <a href="index.html"><img class="home-icon" src="images/home.svg" alt=""></a>
    <div class="search-input">
        <i id="search_icon" class="layui-icon layui-icon-search search-icon"></i>
        <input type="text" id="search_text" name="search_text" placeholder="搜索备忘录" autocomplete="off"
               class="layui-input">
        <i id="search_close" class="layui-icon layui-icon-close-fill search-close layui-anim layui-anim-fadein"
           style="display:none;"></i>
        <div id="search_info">
            <i class="layui-icon layui-icon-left" onclick="preSearch()"></i>
            <span>0/0</span>
            <i class="layui-icon layui-icon-right" onclick="nextSearch()"></i>
        </div>
    </div>
    <button class="layui-btn layui-btn-xs" type="button" id="logout">退出</button>
</div>
<div class="center" id="center">
    <div class="main">
        <div id="memorandumList" class="memorandum-list"></div>
    </div>
</div>
<div class="footer">
    © 2020 网络收藏夹 || 网络收藏夹版权所有
</div>
<!-- 找不到结果 -->
<div id="notFoundDiv" class="notFoundDiv">
    <img src="images/note.svg" alt="">
    <span>备忘录是空</span>
</div>
<script src="layui/jquery-3.1.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="layui/config.js"></script>
<script src="layui/layui.js"></script>
<script>
    layui.use(['layer','flow','util','form'], function() {
        var layer = layui.layer;
        var flow = layui.flow;
        var util = layui.util;
        var form = layui.form;

        // 全局变量
        var searchIndex = -1;

        // 固定块
        util.fixbar({
            top: true
            ,bar1: '&#xe654;'
            ,bar2: '&#xe6dc;'
            ,scrollElem: '#center'
            ,bgcolor: '#393D49'
            ,css: {right: 50, bottom: 80}
            ,click: function(type,ele){
                if(type === 'bar1'){
                    addMemorandum();
                }else if(type === 'bar2'){
                    layer.tips('该功能暂未开放', ele, {tips: 4});
                }
            }
            ,mouseenter: function(type,ele){
                if(type === 'top'){
                    layer.tips('回到顶部', ele, {tips: 4});
                }else if(type === 'bar1'){
                    layer.tips('添加', ele, {tips: 4});
                }else if(type === 'bar2'){
                    layer.tips('录音', ele, {tips: 4});
                }
            }
            ,mouseleave: function(ele,type){
                layer.closeAll('tips');
            }
        });

        // 计算函数方法
        window.todo_time = function(time) {
            if (!time) {
              return '';
            }
            var oDate = new Date();
            var newHaoMiao1 = oDate.getTime(); // 当前时间,含有时分秒
            oDate.setHours(0);
            oDate.setMinutes(0);
            oDate.setSeconds(0);
            oDate.setMilliseconds(0);
            var newHaoMiao2 = oDate.getTime(); // 当前时间,不含有时分秒
            var newTime = time.replace(new RegExp("-", "gm"), "/");
            var arrTime = time.substring(0, 11).replace(new RegExp("-", "gm"), "/"); // 截取时间，不含有时分秒
            var showTime = time.substring(0, 11);
            var oldHaoMiao1 = new Date(newTime).getTime(); // 含有时分秒的转化成毫秒
            var oldHaoMiao2 = new Date(arrTime).getTime(); // 不含有时分秒的转化成毫秒
            var d1 = (newHaoMiao1 - oldHaoMiao1) / 1000;
            var d2 = (newHaoMiao2 - oldHaoMiao2) / 1000;
            var d_result = '';
            if (d2 > 0) { // 是几天前
              var d_days = parseInt(d2 / 86400);
              if (d_days === 1) {
                d_result = "昨天";
              } else if (d_days >= 2) {
                d_result = showTime;
              }
            } else { // 是今天
              var d_hours = parseInt(d1 / 3600);
              var d_minutes = parseInt(d1 / 60);
              if (d_hours > 0) {
                d_result = d_hours + "小时前";
              } else if (d_hours <= 0 && d_minutes > 0) {
                d_result = d_minutes + "分钟前";
              } else {
                d_result = "刚刚";
              }
            }
            return d_result;
        };

        // 加载数据
        window.loadList = function(){
            // 加载动画
            layer.load();
            $("#memorandumList").empty();
            var keyword = $("#search_text").val().trim();
            $("#search_text").attr("data-lastSearch",keyword);
            $('#center').unbind();
            flow.load({
                elem: '#memorandumList'
                ,scrollElem: '#center'
                ,mb: 400
                ,end: ' '
                ,done: function(page, next){
                  var lis = [];
                  $.ajax({
                        type: "GET",
                        url: "memorandum/list",
                        data: {"pageNum": page,"pageSize": 20,"content":keyword},
                        dataType: "json",
                        headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                        success: function (result) {
                            if(page == 1){// 首次加载
                                layer.closeAll('loading');
                                if(keyword && result.code == 0 && result.data.list.length > 0){
                                    searchIndex = 0;
                                }else{
                                    searchIndex = -1;
                                    $("#search_info").hide();
                                }
                                if(result.code == 0 && result.data.list.length > 0){
                                     $("#notFoundDiv").hide();
                                }else{
                                     $("#notFoundDiv").show();
                                }
                            }
                            if (result.code == 0) {
                                $.each(result.data.list, function(index, item){
                                    var html = '';
                                    html += '<div class="memorandum-item layui-anim layui-anim-fadein" data-id="' + item.id + '">';
                                    if(keyword){
                                        html += '<div class="memorandum-content" data-keyword="'+ keyword +'" ondblclick="editContent(this,evnet)">'+ wrapSearch(item.content,keyword) +'</div>';
                                    }else{
                                        html += '<div class="memorandum-content" ondblclick="editContent(this)">'+ item.content +'</div>';
                                    }
                                    html += '</div>';
                                    lis.push(html);
                                });
                                next(lis.join(''), page < result.data.pages);
                            }
                        }
                  });
                }
            });
        };

        loadList();

        // 登出
        $("#logout").click(function () {
            layer.confirm('确认退出系统吗？', function(index){
                layer.close(index);

                localStorage.clear();
                window.location.href = "login.html";
            });
        });

        // 点击空白关闭
        $(document).on("click", function(e) {
            var _conss = $('.search-input');//点击的容器范围
            if (!_conss.is(e.target) && _conss.has(e.target).length === 0) {
                $("#search_close").hide();
            }
        });

        window.escapeHtml = function(str){
             return str.replace(/[<>&"\s\n]/ig,function(c){return {'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',' ':'&nbsp;','\n':'<br/>'}[c];});
        };

        window.htmlEscape = function(html){
             return html.replace(/&lt;|&gt;|&amp;|&quot;|&nbsp;|<br\/>/ig,function(c){return {'&lt;':'<','&gt;':'>','&amp;':'&','&quot;':'"','&nbsp;':' ','<br/>':'\n'}[c];});
        };

        window.preSearch = function(){
            var highLight = $(".highLight");
            var active = highLight.filter(".active");
            var index = highLight.index(active[0]);
            if(index > 0){
                active.removeClass("active");
                var pre = highLight.eq(index - 1).addClass("active");
                $("#search_info").find("span").text(index + "/" + highLight.length);
                $("#center").animate({scrollTop: pre[0].offsetTop - 100}, 50);
                searchIndex--;
            }
        };

        window.nextSearch = function(){
            var highLight = $(".highLight");
            var active = highLight.filter(".active");
            var index = highLight.index(active[0]);
            if(index < highLight.length - 1 ){
                active.removeClass("active");
                var next = highLight.eq(index + 1).addClass("active");
                $("#search_info").find("span").text((index + 2) + "/" + highLight.length);
                $("#center").animate({scrollTop: next[0].offsetTop - 100}, 50);
                searchIndex++;
            }
        };

        window.wrapSearch = function(content,keyword){
            var text = '<span class="highLight">'+keyword+'</span>';
            var reg = new RegExp(keyword,"gi");
            return content.replace(reg,text);
        };

         window.unwrapSearch = function(content,keyword){
            var text = '<span class="highLight">'+keyword+'</span>';
            var reg = new RegExp(text,"gi");
            return content.replace(reg,keyword);
        };

        // 关闭搜索
        $("#search_close").click(function () {
            $(this).hide();
            $("#search_text").val("");
            $("#search_info").hide();
            searchIndex = -1;
            loadList();
        });

        $(document).on("keydown", function(event){
            if(event.ctrlKey && event.key === "f"){
                $("#search_text").focus();
                // 阻止默认浏览器动作(W3C)
                var e = event;
                if ( e && e.preventDefault )
                    e.preventDefault();
                // IE中阻止函数器默认动作的方式
                else
                    window.event.returnValue = false;
                return false;
            }
        });

        window.searchCount = function(){
            // 记录搜索次数
            $.ajax({
                type: "GET",
                url: "user/search",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")}
            });
        };

        $("#search_text").on("keydown", function(event){
            if(event.key === "Enter"){
                var noChange = $(this).val() == $(this).attr("data-lastSearch");
                if(noChange && searchIndex >= 0){
                    var highLight = $(".highLight");
                    var active = highLight.eq(searchIndex);
                    if(active[0]){
                        $("#search_info").show().find("span").text((searchIndex + 1) + "/" + highLight.length);
                        $(".highLight.active").removeClass("active");
                        active.addClass("active");
                        $("#center").animate({scrollTop: active[0].offsetTop - 100}, 50);
                        if(searchIndex < highLight.length - 1){
                            searchIndex++;
                        }else{
                            searchIndex = 0;
                        }
                    }else{
                        $("#search_info").show().find("span").text("0/0");
                    }
                }else{
                    loadList();
                    if($(this).val() != ""){
                        searchCount();
                    }
                }
            } else if (event.key === "Backspace") {
                // 退出选择模式
                searchIndex = -1;
            }
        }).on("focus", function () {
           $("#search_close").show();
        });

        $("#search_icon").click(function(){
            loadList();
        });

        window.addMemorandum = function(){
            var width = (windowWidth >= 800? 800 : windowWidth) + 'px';
            layer.prompt({
              formType: 2,
              placeholder: "请输入内容...",
              title: '添加备忘录',
              area: [width, '350px'] //自定义文本域宽高
            }, function(value, index, elem){
                if(value.trim() == ""){
                    layer.msg("请输入有效字符");
                    return false;
                }
                layer.close(index);
                layer.load();
                  $.ajax({
                    type: "POST",
                    url: "memorandum",
                    data: JSON.stringify({"content":escapeHtml(value)}),
                    contentType: 'application/json;charset=utf-8',
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        layer.closeAll('loading');
                        if (result.code == 0) {
                            window.location.reload();
                        } else {
                            layer.msg(result.msg, {icon: 5});
                        }
                    }
                });
            });
        };

        // 删除
        window.deleteMemorandum = function(id){
            layer.confirm('确认删除吗?', function(index) {
                $.ajax({
                    type: "GET",
                    url: "memorandum/delete/" + id,
                    dataType: "json",
                    headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                    success: function (result) {
                        if (result.code == 0) {
                            window.location.reload();
                        }
                    }
                });
                layer.close(index);
            });
        };

        // 编辑
        window.editContent = function(obj) {
            var id = $(obj).parent().attr("data-id");
            $.ajax({
                type: "GET",
                url: "memorandum/" + id,
                dataType: "json",
                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                success: function (result) {
                    if (result.code == 0) {
                        var width = (windowWidth >= 800? 800 : windowWidth) + 'px';
                        layer.prompt({
                          formType: 2,
                          value: htmlEscape(result.data.content),
                          placeholder: "请输入内容...",
                          title: '编辑备忘录',
                          area: [width, '350px'],
                          success: function(layero, index){
                            layero.prepend('<button class="layui-btn layui-btn-danger layui-btn-del" onclick="deleteMemorandum('+ id +')">删除</button>');
                          }
                        }, function(value, index, elem){
                            if(value.trim() == ""){
                                layer.msg("请输入有效字符");
                                return false;
                            }
                            layer.close(index);
                            layer.load();
                              $.ajax({
                                type: "POST",
                                url: "memorandum",
                                data: JSON.stringify({id: id, "content": escapeHtml(value)}),
                                contentType: 'application/json;charset=utf-8',
                                dataType: "json",
                                headers:{"Authorization": "Bearer "+ localStorage.getItem("login_user_token")},
                                success: function (result) {
                                    layer.closeAll('loading');
                                    if (result.code == 0) {
                                        window.location.reload();
                                    } else {
                                        layer.msg(result.msg, {icon: 5});
                                    }
                                }
                            });
                        });
                    } else {
                        layer.msg(result.msg, {icon: 5});
                    }
                }
            });
        };
    });

</script>
</body>
</html>
